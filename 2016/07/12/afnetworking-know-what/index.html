<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="iOS高级工程师"><title>AFNetWorking 深度理解 | 王孟发</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">AFNetWorking 深度理解</h1><a id="logo" href="/.">王孟发</a><p class="description">跟着梦想去飞翔~   https://github.com/wmf00032</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about.html"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">AFNetWorking 深度理解</h1><div class="post-meta">Jul 12, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/07/12/afnetworking-know-what/" href="/2016/07/12/afnetworking-know-what/#comments" class="ds-thread-count"></a><a data-disqus-identifier="2016/07/12/afnetworking-know-what/" href="/2016/07/12/afnetworking-know-what/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>先看一下<code>afnetworking</code>的目录结构：</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/652024-cd53ec5e18c218a4.png?raw=true" alt="图1.0"></p>
<p>大家都看见了网络请求其实有两种方式。一种是用<code>AFHTTPRequestOperationManager</code> ，另一种是用<code>AFHTTPSessionManager</code>。那么这两种有什么区别尼？ </p>
<p>估计又的人有所不知，<code>AFNetworking</code>最初的版本使用的就是<code>AFHTTPRequestOperationManager</code> 以就是自己自定义<code>NSOperation</code>的封装实现的。<code>AFHTTPSessionManager</code>是在<code>2.0</code>以后才引入进来的。以就是说在<code>2.0</code>之前，都是使用<code>AFHTTPRequestOperationManager</code>。</p>
<p><code>AFHTTPSessionManager</code> 继承自 <code>AFURLSessionManager</code>，而<code>AFURLSessionManager</code>主要是使用系统提供的 <code>NSURLSession</code>和<code>NSURLSessionTask</code>进行网络操作的。我们看一下官方文档对这两个类的描述：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NS_CLASS_AVAILABLE</span>(<span class="built_in">NSURLSESSION_AVAILABLE</span>, <span class="number">7</span>_0)</div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSURLSession</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * NSURLSessionTask - a cancelable object that refers to the lifetime</div><div class="line"> * of processing a given request.</div><div class="line"> */</div><div class="line"><span class="built_in">NS_CLASS_AVAILABLE</span>(<span class="built_in">NSURLSESSION_AVAILABLE</span>, <span class="number">7</span>_0)</div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSURLSessionTask</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCopying</span>&gt;</span></div></pre></td></tr></table></figure>
<p>是的，你没有看错，<code>NSURLSession</code>和<code>NSURLSessionTask</code>是<code>iOS7</code>以后才出现的，所以如果你想要适配到<code>iOS6</code>，那么请你乖乖的使用前者 进行网络请求。这就解释了为什么作者会把两种请求方式都放在这儿。</p>
<p>下面分两部分进行网络<code>AFNetworking</code>网络请求的分析：<br><code>AFHTTPRequestOperationManager</code> 部分的网络请求原理：</p>
<p><code>AFHTTPRequestOperationManager</code>的<code>init</code>方法是这样的：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">instancetype</span>)initWithBaseURL:(<span class="built_in">NSURL</span> *)url &#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Ensure terminal slash for baseURL path, so that NSURL +URLWithString:relativeToURL: works as expected</span></div><div class="line">    <span class="keyword">if</span> ([[url path] length] &gt; <span class="number">0</span> &amp;&amp; ![[url absoluteString] hasSuffix:<span class="string">@"/"</span>]) &#123;</div><div class="line">        url = [url URLByAppendingPathComponent:<span class="string">@""</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.baseURL = url;</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.requestSerializer = [AFHTTPRequestSerializer serializer];</div><div class="line">    <span class="keyword">self</span>.responseSerializer = [AFJSONResponseSerializer serializer];</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.securityPolicy = [AFSecurityPolicy defaultPolicy];</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.reachabilityManager = [AFNetworkReachabilityManager sharedManager];</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.operationQueue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.shouldUseCredentialStorage = <span class="literal">YES</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中默认的请求方式和解析方式被设置了默认值：</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">self.requestSerializer = <span class="string">[AFHTTPRequestSerializer serializer]</span>;</div><div class="line">self.responseSerializer = <span class="string">[AFJSONResponseSerializer serializer]</span>;</div></pre></td></tr></table></figure>
<p><strong>当然用户可以修改这两个参数，指定自己的请求方式和解析方式。</strong></p>
<p>下面以<code>GET</code>请求为例来说。<br>当用户发起一个<code>GET</code>请求，下面的方法会被掉用：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (AFHTTPRequestOperation *)<span class="string">GET:</span>(NSString *)URLString</div><div class="line"><span class="symbol">                     parameters:</span>(id)parameters</div><div class="line"><span class="symbol">                        success:</span>(<span class="keyword">void</span> (^)(AFHTTPRequestOperation *operation, id responseObject))success</div><div class="line"><span class="symbol">                        failure:</span>(<span class="keyword">void</span> (^)(AFHTTPRequestOperation *operation, NSError *error))failure</div><div class="line">&#123;</div><div class="line">    AFHTTPRequestOperation *operation = [self <span class="string">HTTPRequestOperationWithHTTPMethod:</span>@<span class="string">"GET"</span> <span class="string">URLString:</span>URLString <span class="string">parameters:</span>parameters <span class="string">success:</span>success <span class="string">failure:</span>failure];</div><div class="line"></div><div class="line">    [self.operationQueue <span class="string">addOperation:</span>operation];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> operation;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中<code>[self.operationQueue addOperation:operation];</code>就是将当前的任务放进操作队列。<br>关键我们看看<code>AFHTTPRequestOperation</code> 里面都做了什么。</p>
<p><code>AFHTTPRequestOperation</code> 是继承自<code>AFURLConnectionOperation</code>，<code>AFURLConnectionOperation</code>实现了各种代理：</p>
<p><code>@interface AFURLConnectionOperation : NSOperation &lt;NSURLConnectionDelegate, NSURLConnectionDataDelegate, NSSecureCoding, NSCopying&gt;</code></p>
<p>我们知道当一个<code>operation</code>任务被启动的时候<code>start</code>方法就会被调用：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)start &#123;</div><div class="line">    [<span class="keyword">self</span>.lock lock];</div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> isCancelled]) &#123;</div><div class="line">        [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(cancelConnection) onThread:[[<span class="keyword">self</span> <span class="keyword">class</span>] networkRequestThread] withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">NO</span> modes:[<span class="keyword">self</span>.runLoopModes allObjects]];</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span> isReady]) &#123;</div><div class="line">        <span class="keyword">self</span>.state = AFOperationExecutingState;</div><div class="line"></div><div class="line">        [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(operationDidStart) onThread:[[<span class="keyword">self</span> <span class="keyword">class</span>] networkRequestThread] withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">NO</span> modes:[<span class="keyword">self</span>.runLoopModes allObjects]];</div><div class="line">    &#125;</div><div class="line">    [<span class="keyword">self</span>.lock unlock];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)operationDidStart &#123;</div><div class="line">    [<span class="keyword">self</span>.lock lock];</div><div class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> isCancelled]) &#123;</div><div class="line">        <span class="keyword">self</span>.connection = [[<span class="built_in">NSURLConnection</span> alloc] initWithRequest:<span class="keyword">self</span>.request delegate:<span class="keyword">self</span> startImmediately:<span class="literal">NO</span>];</div><div class="line"></div><div class="line">        <span class="built_in">NSRunLoop</span> *runLoop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</div><div class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> *runLoopMode <span class="keyword">in</span> <span class="keyword">self</span>.runLoopModes) &#123;</div><div class="line">            [<span class="keyword">self</span>.connection scheduleInRunLoop:runLoop forMode:runLoopMode];</div><div class="line">            [<span class="keyword">self</span>.outputStream scheduleInRunLoop:runLoop forMode:runLoopMode];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        [<span class="keyword">self</span>.outputStream open];</div><div class="line">        [<span class="keyword">self</span>.connection start];</div><div class="line">    &#125;</div><div class="line">    [<span class="keyword">self</span>.lock unlock];</div><div class="line"></div><div class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">        [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingOperationDidStartNotification object:<span class="keyword">self</span>];</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们分析一下一上代码块，当<code>AFURLConnectionOperation</code>任务被正常启动的时候，下面的方法会被调用：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(operationDidStart) onThread:[[<span class="keyword">self</span> <span class="keyword">class</span>] networkRequestThread] withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">NO</span> modes:[<span class="keyword">self</span>.runLoopModes allObjects]];</div><div class="line"></div><div class="line">operationDidStart方法会在[[<span class="keyword">self</span> <span class="keyword">class</span>] networkRequestThread]返回的线程中被调用。我们看看这是一个什么样的线程：</div><div class="line">+ (<span class="keyword">void</span>)networkRequestThreadEntryPoint:(<span class="keyword">id</span>)__unused object &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        [[<span class="built_in">NSThread</span> currentThread] setName:<span class="string">@"AFNetworking"</span>];</div><div class="line"></div><div class="line">        <span class="built_in">NSRunLoop</span> *runLoop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</div><div class="line">        [runLoop addPort:[<span class="built_in">NSMachPort</span> port] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</div><div class="line">        [runLoop run];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">NSThread</span> *)networkRequestThread &#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">NSThread</span> *_networkRequestThread = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> oncePredicate;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;oncePredicate, ^&#123;</div><div class="line">        _networkRequestThread = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(networkRequestThreadEntryPoint:) object:<span class="literal">nil</span>];</div><div class="line">        [_networkRequestThread start];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> _networkRequestThread;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>是的这个新的小线程命名为<strong>“AFNetworking”</strong>, 它在床见得时候就启动了一个人<code>runloop</code>事件循环，并添加了一个<code>NSMachPort</code> 空端口，改<code>NSMachPort</code> 仅仅只是一个空的端口其目的是用来维护<code>runloop</code>的执行不被退出。</p>
<p><code>operationDidStart</code> 方法中的：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">self</span>.connection = [[<span class="built_in">NSURLConnection</span> alloc] initWithRequest:<span class="keyword">self</span>.request delegate:<span class="keyword">self</span> startImmediately:<span class="literal">NO</span>];</div><div class="line">        <span class="built_in">NSRunLoop</span> *runLoop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</div><div class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> *runLoopMode <span class="keyword">in</span> <span class="keyword">self</span>.runLoopModes) &#123;</div><div class="line">            [<span class="keyword">self</span>.connection scheduleInRunLoop:runLoop forMode:runLoopMode];</div><div class="line">            [<span class="keyword">self</span>.outputStream scheduleInRunLoop:runLoop forMode:runLoopMode];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        [<span class="keyword">self</span>.outputStream open];</div><div class="line">        [<span class="keyword">self</span>.connection start];</div></pre></td></tr></table></figure>
<p>说明<code>self.connection</code>和<code>self.outputStream</code>周期性任务被绑定在当期的<code>runloop</code>的<code>self.runLoopModes</code> 模式中。（<code>self.runLoopModes</code>在初始化的时候被赋值为<code>[NSSet setWithObject:NSRunLoopCommonModes]</code>）</p>
<p>行了，那么当网络请求数据到达的时候，数据是如何被接收到的尼，我想这一点才是大家最关心的。<br>网络请求是一个异步的过程，当网络请求数据流到达的时候，<code>runloop</code>监听到改事件源，<code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__</code>方法会被调用。之后<code>CFNetwork</code>的<code>_NSURLConnectionDidReceiveData(_CFURLConnection*, __CFData const*, long, void const*)</code>放会被调用获取到网络数据。与此同时<code>NSURLConnectionInternal</code>的<code>_withActiveConnectionAndDelegate</code>方法会被调用，本地代理被激活。<code>AFURLConnectionOperation</code>中的代理方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)connection:(<span class="built_in">NSURLConnection</span> __unused *)connection</div><div class="line">    didReceiveData:(<span class="built_in">NSData</span> *)data</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSUInteger</span> length = [data length];</div><div class="line">    <span class="keyword">while</span> (<span class="literal">YES</span>) &#123;</div><div class="line">        <span class="built_in">NSInteger</span> totalNumberOfBytesWritten = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.outputStream hasSpaceAvailable]) &#123;</div><div class="line">            <span class="keyword">const</span> uint8_t *dataBuffer = (uint8_t *)[data bytes];</div><div class="line"></div><div class="line">            <span class="built_in">NSInteger</span> numberOfBytesWritten = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span> (totalNumberOfBytesWritten &lt; (<span class="built_in">NSInteger</span>)length) &#123;</div><div class="line">                numberOfBytesWritten = [<span class="keyword">self</span>.outputStream write:&amp;dataBuffer[(<span class="built_in">NSUInteger</span>)totalNumberOfBytesWritten] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesWritten)];</div><div class="line">                <span class="keyword">if</span> (numberOfBytesWritten == <span class="number">-1</span>) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                totalNumberOfBytesWritten += numberOfBytesWritten;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            [<span class="keyword">self</span>.connection cancel];</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.outputStream.streamError) &#123;</div><div class="line">                [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(connection:didFailWithError:) withObject:<span class="keyword">self</span>.connection withObject:<span class="keyword">self</span>.outputStream.streamError];</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">        <span class="keyword">self</span>.totalBytesRead += (<span class="keyword">long</span> <span class="keyword">long</span>)length;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.downloadProgress) &#123;</div><div class="line">            <span class="keyword">self</span>.downloadProgress(length, <span class="keyword">self</span>.totalBytesRead, <span class="keyword">self</span>.response.expectedContentLength);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>被调用，通过以上代码中的：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">           <span class="built_in">NSInteger</span> numberOfBytesWritten = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span> (totalNumberOfBytesWritten &lt; (<span class="built_in">NSInteger</span>)length) &#123;</div><div class="line">                numberOfBytesWritten = [<span class="keyword">self</span>.outputStream write:&amp;dataBuffer[(<span class="built_in">NSUInteger</span>)totalNumberOfBytesWritten] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesWritten)];</div><div class="line">                <span class="keyword">if</span> (numberOfBytesWritten == <span class="number">-1</span>) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                totalNumberOfBytesWritten += numberOfBytesWritten;</div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<p>网络数据流被写入缓存。数据被写入缓存完成后，代理方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)connectionDidFinishLoading:(<span class="built_in">NSURLConnection</span> __unused *)connection &#123;</div><div class="line">    <span class="keyword">self</span>.responseData = [<span class="keyword">self</span>.outputStream propertyForKey:<span class="built_in">NSStreamDataWrittenToMemoryStreamKey</span>];</div><div class="line"></div><div class="line">    [<span class="keyword">self</span>.outputStream close];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.responseData) &#123;</div><div class="line">       <span class="keyword">self</span>.outputStream = <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.connection = <span class="literal">nil</span>;</div><div class="line"></div><div class="line">    [<span class="keyword">self</span> finish];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>会被调用后。我们追踪<code>[self finish];</code> 看看它里面的实现：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)finish &#123;</div><div class="line">    [<span class="literal">self</span>.lock lock];</div><div class="line">    <span class="literal">self</span>.<span class="keyword">state</span> = AFOperationFinishedState;</div><div class="line">    [<span class="literal">self</span>.lock unlock];</div><div class="line"></div><div class="line">    dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">        [[NSNotificationCenter <span class="keyword">default</span>Center] postNotificationName:AFNetworkingOperationDidFinishNotification object:<span class="literal">self</span>];</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>self.state = AFOperationFinishedState</code>这句代码是重点，它标示了该请求任务已经结束。而这句赋值还做了一个KVO的操作，如下代码：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">- (void)<span class="built_in">set</span>State:(AFOperationState)<span class="keyword">state</span> &#123;</div><div class="line">    if (!AFStateTransitionIsValid(<span class="literal">self</span>.<span class="keyword">state</span>, <span class="keyword">state</span>, [<span class="literal">self</span> isCancelled])) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    [<span class="literal">self</span>.lock lock];</div><div class="line">    NSString *oldStateKey = AFKeyPathFromOperationState(<span class="literal">self</span>.<span class="keyword">state</span>);</div><div class="line">    NSString *newStateKey = AFKeyPathFromOperationState(<span class="keyword">state</span>);</div><div class="line"></div><div class="line">    [<span class="literal">self</span> willChangeValueForKey:newStateKey];</div><div class="line">    [<span class="literal">self</span> willChangeValueForKey:oldStateKey];</div><div class="line">    _state = <span class="keyword">state</span>;</div><div class="line">    [<span class="literal">self</span> didChangeValueForKey:oldStateKey];</div><div class="line">    [<span class="literal">self</span> didChangeValueForKey:newStateKey];</div><div class="line">    [<span class="literal">self</span>.lock unlock];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>NSOperationInternal</code>中的<code>_observeValueForKeyPath:ofObject:changeKind:oldValue:newValue:indexes:context:</code>方法会监听<code>state</code>状态的改变。然后回归到主线程，AFURLConnectionOperation中的<code>setCompletionBlock</code>方法被回调：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setCompletionBlock:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block &#123;</div><div class="line">    [<span class="keyword">self</span>.lock lock];</div><div class="line">    <span class="keyword">if</span> (!block) &#123;</div><div class="line">        [<span class="keyword">super</span> setCompletionBlock:<span class="literal">nil</span>];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        __<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)weakSelf = <span class="keyword">self</span>;</div><div class="line">        [<span class="keyword">super</span> setCompletionBlock:^ &#123;</div><div class="line">            __<span class="keyword">strong</span> __<span class="keyword">typeof</span>(weakSelf)strongSelf = weakSelf;</div><div class="line"></div><div class="line"><span class="meta">#pragma clang diagnostic push</span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wgnu"</span></span></div><div class="line">            dispatch_group_t group = strongSelf.completionGroup ?: url_request_operation_completion_group();</div><div class="line">            <span class="built_in">dispatch_queue_t</span> queue = strongSelf.completionQueue ?: dispatch_get_main_queue();</div><div class="line"><span class="meta">#pragma clang diagnostic pop</span></div><div class="line"></div><div class="line">            dispatch_group_async(group, queue, ^&#123;</div><div class="line">                block();</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            dispatch_group_notify(group, url_request_operation_completion_queue(), ^&#123;</div><div class="line">                [strongSelf setCompletionBlock:<span class="literal">nil</span>];</div><div class="line">            &#125;);</div><div class="line">        &#125;];</div><div class="line">    &#125;</div><div class="line">    [<span class="keyword">self</span>.lock unlock];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关键看这句代码：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dispatch_group_async(<span class="name">group</span>, queue, ^&#123;</div><div class="line">                block()<span class="comment">;</span></div><div class="line">            &#125;)<span class="comment">;</span></div></pre></td></tr></table></figure>
<p><code>block()</code>一调用就调用到了<code>AFHTTPRequestOperation</code>的方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#pragma mark - AFHTTPRequestOperation</span></div><div class="line">- (<span class="keyword">void</span>)setCompletionBlockWithSuccess:(<span class="keyword">void</span> (^)(AFHTTPRequestOperation *operation, <span class="keyword">id</span> responseObject))success</div><div class="line">                              failure:(<span class="keyword">void</span> (^)(AFHTTPRequestOperation *operation, <span class="built_in">NSError</span> *error))failure</div><div class="line">&#123;</div><div class="line">    <span class="comment">// completionBlock is manually nilled out in AFURLConnectionOperation to break the retain cycle.</span></div><div class="line"><span class="meta">#pragma clang diagnostic push</span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Warc-retain-cycles"</span></span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wgnu"</span></span></div><div class="line">    <span class="keyword">self</span>.completionBlock = ^&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.completionGroup) &#123;</div><div class="line">            dispatch_group_enter(<span class="keyword">self</span>.completionGroup);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="built_in">dispatch_async</span>(http_request_operation_processing_queue(), ^&#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.error) &#123;</div><div class="line">                <span class="keyword">if</span> (failure) &#123;</div><div class="line">                    dispatch_group_async(<span class="keyword">self</span>.completionGroup ?: http_request_operation_completion_group(), <span class="keyword">self</span>.completionQueue ?: dispatch_get_main_queue(), ^&#123;</div><div class="line">                        failure(<span class="keyword">self</span>, <span class="keyword">self</span>.error);</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">id</span> responseObject = <span class="keyword">self</span>.responseObject;</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.error) &#123;</div><div class="line">                    <span class="keyword">if</span> (failure) &#123;</div><div class="line">                        dispatch_group_async(<span class="keyword">self</span>.completionGroup ?: http_request_operation_completion_group(), <span class="keyword">self</span>.completionQueue ?: dispatch_get_main_queue(), ^&#123;</div><div class="line">                            failure(<span class="keyword">self</span>, <span class="keyword">self</span>.error);</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (success) &#123;</div><div class="line">                        dispatch_group_async(<span class="keyword">self</span>.completionGroup ?: http_request_operation_completion_group(), <span class="keyword">self</span>.completionQueue ?: dispatch_get_main_queue(), ^&#123;</div><div class="line">                            success(<span class="keyword">self</span>, responseObject);</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.completionGroup) &#123;</div><div class="line">                dispatch_group_leave(<span class="keyword">self</span>.completionGroup);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;;</div><div class="line"><span class="meta">#pragma clang diagnostic pop</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>self.completionBlock</code>中的内容被执行，这里面最关键的一句id <code>responseObject = self.responseObject</code> 获得了解析数据，我们看看<code>self.responseObject</code>的实现：</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (id)responseObject &#123;</div><div class="line">    [<span class="built_in">self</span>.lock lock];</div><div class="line">    <span class="keyword">if</span> (!_responseObject &amp;&amp; [<span class="built_in">self</span> isFinished] &amp;&amp; !<span class="built_in">self</span>.<span class="built_in">error</span>) &#123;</div><div class="line">        NSError *<span class="built_in">error</span> = nil;</div><div class="line">        <span class="built_in">self</span>.responseObject = [<span class="built_in">self</span>.responseSerializer responseObjectForResponse:<span class="built_in">self</span>.response data:<span class="built_in">self</span>.responseData <span class="built_in">error</span>:&amp;<span class="built_in">error</span>];</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">error</span>) &#123;</div><div class="line">            <span class="built_in">self</span>.responseSerializationError = <span class="built_in">error</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    [<span class="built_in">self</span>.lock unlock];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> _responseObject;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>我靠！春天来了</strong>，这句代码：</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">self</span>.responseObject = [<span class="built_in">self</span>.responseSerializer responseObjectForResponse:<span class="built_in">self</span>.response data:<span class="built_in">self</span>.responseData <span class="built_in">error</span>:&amp;<span class="built_in">error</span>];</div></pre></td></tr></table></figure>
<p>将<code>stream</code>中的数据解析成了我们想要数据比如<code>json、xml、plist</code>等等。然后<code>AFHTTPRequestOperation</code>方法<code>setCompletionBlockWithSuccess</code>中代码<code>success(self, responseObject)</code>一回调。好了，现在就不用说了，我们通常就是在这个<code>success</code> <code>block</code>做我们自己的处理的。</p>
<p>下面我们看一下<code>AFHTTPSessionManager</code> 网络请求是怎么样进行的<br>苹果已经对<code>NSURLSessionDataTask</code>做了高度的封装，类似于<code>AFURLConnectionOperation</code>这样的复杂封装已经看不见了。但是原理跟<code>AFURLConnectionOperation</code>的差不多这里就不在赘述了。</p>
<p>到一个网络数据流到达的时候，<code>NSURLSession的URLSession:dataTask:didReceiveData:</code>方法就会被激活。<code>AFURLSessionManager</code>实现了<code>NSURLSession</code>的代理，于是乎<code>AFURLSessionManager</code>中的代理方法就会被调用：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</div><div class="line">          dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</div><div class="line">    didReceiveData:(<span class="built_in">NSData</span> *)data</div><div class="line">&#123;</div><div class="line">    AFURLSessionManagerTaskDelegate *delegate = [<span class="keyword">self</span> delegateForTask:dataTask];</div><div class="line">    [delegate URLSession:session dataTask:dataTask didReceiveData:data];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.dataTaskDidReceiveData) &#123;</div><div class="line">        <span class="keyword">self</span>.dataTaskDidReceiveData(session, dataTask, data);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>[delegate URLSession:session dataTask:dataTask didReceiveData:data]</code>里面的实现四这样的：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">URLSession</span><span class="selector-pseudo">:(__unused</span> <span class="selector-tag">NSURLSession</span> *)<span class="selector-tag">session</span></div><div class="line">          <span class="selector-tag">dataTask</span><span class="selector-pseudo">:(__unused</span> <span class="selector-tag">NSURLSessionDataTask</span> *)<span class="selector-tag">dataTask</span></div><div class="line">    <span class="selector-tag">didReceiveData</span><span class="selector-pseudo">:(NSData</span> *)<span class="selector-tag">data</span></div><div class="line">&#123;</div><div class="line">    <span class="selector-attr">[self.mutableData appendData:data]</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样网络数据就被写入了<code>self.mutableData</code>。<br>当数据获取完成之后<code>URLSession:task:didCompleteWithError:</code>方法就会被调用：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)URLSession:(NSURLSession *)session</div><div class="line">              <span class="keyword">task</span>:(NSURLSessionTask *)<span class="keyword">task</span></div><div class="line">didCompleteWithError:(NSError *)error</div><div class="line">&#123;</div><div class="line">    AFURLSessionManagerTaskDelegate *delegate = [self delegateForTask:<span class="keyword">task</span>];</div><div class="line"></div><div class="line">    <span class="comment">// delegate may be nil when completing a task in the background</span></div><div class="line">    <span class="keyword">if</span> (delegate) &#123;</div><div class="line">        [delegate URLSession:session <span class="keyword">task</span>:<span class="keyword">task</span> didCompleteWithError:error];</div><div class="line"></div><div class="line">        [self removeDelegateForTask:<span class="keyword">task</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (self.taskDidComplete) &#123;</div><div class="line">        self.taskDidComplete(session, <span class="keyword">task</span>, error);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们看看 <code>[delegate URLSession:session task:task didCompleteWithError:error]</code> 方法中的实现：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)URLSession:(__unused <span class="built_in">NSURLSession</span> *)session</div><div class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</div><div class="line">didCompleteWithError:(<span class="built_in">NSError</span> *)error</div><div class="line">&#123;</div><div class="line"><span class="meta">#pragma clang diagnostic push</span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wgnu"</span></span></div><div class="line">    __<span class="keyword">strong</span> AFURLSessionManager *manager = <span class="keyword">self</span>.manager;</div><div class="line"></div><div class="line">    __block <span class="keyword">id</span> responseObject = <span class="literal">nil</span>;</div><div class="line"></div><div class="line">    __block <span class="built_in">NSMutableDictionary</span> *userInfo = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">    userInfo[AFNetworkingTaskDidCompleteResponseSerializerKey] = manager.responseSerializer;</div><div class="line"></div><div class="line">    <span class="comment">//Performance Improvement from #2672</span></div><div class="line">    <span class="built_in">NSData</span> *data = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.mutableData) &#123;</div><div class="line">        data = [<span class="keyword">self</span>.mutableData <span class="keyword">copy</span>];</div><div class="line">        <span class="comment">//We no longer need the reference, so nil it out to gain back some memory.</span></div><div class="line">        <span class="keyword">self</span>.mutableData = <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.downloadFileURL) &#123;</div><div class="line">        userInfo[AFNetworkingTaskDidCompleteAssetPathKey] = <span class="keyword">self</span>.downloadFileURL;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data) &#123;</div><div class="line">        userInfo[AFNetworkingTaskDidCompleteResponseDataKey] = data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (error) &#123;</div><div class="line">        userInfo[AFNetworkingTaskDidCompleteErrorKey] = error;</div><div class="line"></div><div class="line">        dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.completionHandler) &#123;</div><div class="line">                <span class="keyword">self</span>.completionHandler(task.response, responseObject, error);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">                [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">dispatch_async</span>(url_session_manager_processing_queue(), ^&#123;</div><div class="line">            <span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</div><div class="line">            responseObject = [manager.responseSerializer responseObjectForResponse:task.response data:data error:&amp;serializationError];</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.downloadFileURL) &#123;</div><div class="line">                responseObject = <span class="keyword">self</span>.downloadFileURL;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (responseObject) &#123;</div><div class="line">                userInfo[AFNetworkingTaskDidCompleteSerializedResponseKey] = responseObject;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (serializationError) &#123;</div><div class="line">                userInfo[AFNetworkingTaskDidCompleteErrorKey] = serializationError;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.completionHandler) &#123;</div><div class="line">                    <span class="keyword">self</span>.completionHandler(task.response, responseObject, serializationError);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">                    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</div><div class="line">                &#125;);</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"><span class="meta">#pragma clang diagnostic pop</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上代码中 <code>data = [self.mutableData copy]</code> 可知网络数据流被<code>copy</code>到了 <code>data</code>之中，关键代码：</p>
<p><code>responseObject = [manager.responseSerializer responseObjectForResponse:task.response data:data error:&amp;serializationError]</code><br>网络数据被解析成了我们最终获取到的数据。<code>self.completionHandler</code>一执行如下代码块：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">if</span> (self.completionHandler) &#123;</div><div class="line">                    self<span class="selector-class">.completionHandler</span>(task.response, responseObject, serializationError);</div><div class="line">                &#125;</div></pre></td></tr></table></figure>
<p>就回到了<code>AFHTTPSessionManager</code>的方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithHTTPMethod:(<span class="built_in">NSString</span> *)method</div><div class="line">                                       URLString:(<span class="built_in">NSString</span> *)URLString</div><div class="line">                                      parameters:(<span class="keyword">id</span>)parameters</div><div class="line">                                         success:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *, <span class="keyword">id</span>))success</div><div class="line">                                         failure:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *, <span class="built_in">NSError</span> *))failure</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</div><div class="line">    <span class="built_in">NSMutableURLRequest</span> *request = [<span class="keyword">self</span>.requestSerializer requestWithMethod:method URLString:[[<span class="built_in">NSURL</span> URLWithString:URLString relativeToURL:<span class="keyword">self</span>.baseURL] absoluteString] parameters:parameters error:&amp;serializationError];</div><div class="line">    <span class="keyword">if</span> (serializationError) &#123;</div><div class="line">        <span class="keyword">if</span> (failure) &#123;</div><div class="line"><span class="meta">#pragma clang diagnostic push</span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wgnu"</span></span></div><div class="line">            <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.completionQueue ?: dispatch_get_main_queue(), ^&#123;</div><div class="line">                failure(<span class="literal">nil</span>, serializationError);</div><div class="line">            &#125;);</div><div class="line"><span class="meta">#pragma clang diagnostic pop</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    __block <span class="built_in">NSURLSessionDataTask</span> *dataTask = <span class="literal">nil</span>;</div><div class="line">    dataTask = [<span class="keyword">self</span> dataTaskWithRequest:request completionHandler:^(<span class="built_in">NSURLResponse</span> * __unused response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error) &#123;</div><div class="line">        <span class="keyword">if</span> (error) &#123;</div><div class="line">            <span class="keyword">if</span> (failure) &#123;</div><div class="line">                failure(dataTask, error);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (success) &#123;</div><div class="line">                success(dataTask, responseObject);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> dataTask;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这<code>block</code>就会被调用：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">    __block <span class="built_in">NSURLSessionDataTask</span> *dataTask = <span class="literal">nil</span>;</div><div class="line">    dataTask = [<span class="keyword">self</span> dataTaskWithRequest:request completionHandler:^(<span class="built_in">NSURLResponse</span> * __unused response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error) &#123;</div><div class="line">        <span class="keyword">if</span> (error) &#123;</div><div class="line">            <span class="keyword">if</span> (failure) &#123;</div><div class="line">                failure(dataTask, error);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (success) &#123;</div><div class="line">                success(dataTask, responseObject);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;];</div></pre></td></tr></table></figure>
<p>这里的<code>success</code>和 <code>failure</code> 就是我们经常看见的回调方法。</p>
<p><strong><em>欢迎交流，你对afnetworking的理解！</em></strong></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/07/12/afnetworking-know-what/" data-id="cit07ui3x0003cjagfy736lt4" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2016/09/06/wechat-secret/" class="pre">（非越狱版）iOS微信聊天加密插件 （一）</a><a href="/2016/07/09/my-new-wmf/" class="next">iOS 基于AVPLayer封装视频播放器</a></div><div data-thread-key="2016/07/12/afnetworking-know-what/" data-title="AFNetWorking 深度理解" data-url="http://yoursite.com/2016/07/12/afnetworking-know-what/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/07/12/afnetworking-know-what/" data-title="AFNetWorking 深度理解" data-url="http://yoursite.com/2016/07/12/afnetworking-know-what/" data-author-key="1" class="ds-thread"></div><div id="disqus_thread"><script>var disqus_shortname = 'wmf00032-github-io';
var disqus_identifier = '2016/07/12/afnetworking-know-what/';
var disqus_title = 'AFNetWorking 深度理解';
var disqus_url = 'http://yoursite.com/2016/07/12/afnetworking-know-what/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wmf00032-github-io.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://yoursite.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/09/12/runtimeClassLoad/">iOS 运行时类的加载深入解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/12/dylib1/">mac和iPhone命令生成可执行文件的区别</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/06/wechat-secret-4/">（非越狱版）iOS微信聊天加密插件 （四）终结篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/06/wechat-secret-3/">（非越狱版）iOS微信聊天加密插件 （三）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/06/wechat-secret-2/">（非越狱版）iOS微信聊天加密插件 （二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/06/wechat-secret/">（非越狱版）iOS微信聊天加密插件 （一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/12/afnetworking-know-what/">AFNetWorking 深度理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/09/my-new-wmf/">iOS 基于AVPLayer封装视频播放器</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//wmf00032-github-io.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">王孟发.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'wmf00032'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>