<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="iOS高级工程师"><title>（非越狱版）iOS微信聊天加密插件 （三） | 王孟发</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">（非越狱版）iOS微信聊天加密插件 （三）</h1><a id="logo" href="/.">王孟发</a><p class="description">跟着梦想去飞翔~   https://github.com/wmf00032</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about.html"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">（非越狱版）iOS微信聊天加密插件 （三）</h1><div class="post-meta">Sep 6, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/09/06/wechat-secret-3/" href="/2016/09/06/wechat-secret-3/#comments" class="ds-thread-count"></a><a data-disqus-identifier="2016/09/06/wechat-secret-3/" href="/2016/09/06/wechat-secret-3/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#基本思路"><span class="toc-number">1.</span> <span class="toc-text">基本思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#文本信息如何显示密文"><span class="toc-number">1.1.</span> <span class="toc-text">文本信息如何显示密文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#方案1"><span class="toc-number">1.1.1.</span> <span class="toc-text">方案1.</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案2"><span class="toc-number">1.1.2.</span> <span class="toc-text">方案2.</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><p>我们已经可以获取到联系人列表了，就可以以此建立一个加密名单，在加密名单里面的联系人聊天界面显示所有的聊天信息都是秘密，录音也不能播放，只用输入正确的界面密令之后，聊天界面才会显示明文，录音也可以正常的播放了。</p>
<h1 id="基本思路"><a href="#基本思路" class="headerlink" title="基本思路"></a>基本思路</h1><p>要实现聊天界面信息加密，我们现在来分析一下基本的思路。当用户在首页点击某个联系人进入聊天界面之后，应该检索改用户是否在“加密联系人”列表之中，如果在，文本信息需要显示密文，录音信息不能点击播放。</p>
<h2 id="文本信息如何显示密文"><a href="#文本信息如何显示密文" class="headerlink" title="文本信息如何显示密文"></a>文本信息如何显示密文</h2><h3 id="方案1"><a href="#方案1" class="headerlink" title="方案1."></a>方案1.</h3><p>首先未删除的聊天记录在本地应该有备份，我们是否可以在加载聊天记录的时候讲文本信息处理成密文，但是这样的话问题来了。新收到的消息和刚刚发送的信息理论上应该是先显示再保存到本地数据库，该如何处理这些消息尼？这样就变得非常复杂啦！这种方案不可行，需要处理很多种消息类型情况</p>
<h3 id="方案2"><a href="#方案2" class="headerlink" title="方案2."></a>方案2.</h3><p>最终的明文是需要显示在<code>cell</code> 控件上，每一个<code>cell</code> 肯定对应一个消息<code>messageModel</code>，不管什么样的消息类型，当需要显示一个cell的时候肯定需要到当前的<code>messageModel</code>中去获取数据，我们是否可以拦截这个过程。以就是说，对于一个文本消息，<code>cell</code>会从对应的<code>messageModel</code>中去取这段文本内容然后显示在界面。我们是否可以在<code>messageModel</code>给<code>cell</code>返回对应文本内容的时候将明文改成密文返回给<code>cell</code>。这样<code>cell</code>拿到的就是一个密文显示出来。当下一次需要解密的时候，只要将这个拦截过程取消，并命令<code>tableView</code> 重新<code>reloadData</code>就可以显示明文消息啦。</p>
<p>是的，就是方案2，如果我们能找到<code>messageModel</code>返回给<code>cell</code> 文本消息的方法，然后将其拦截判断如果该联系在“加密列表”就返回一段密文。这样就能一劳永逸，不管以什么形式出现的文本消息，都能将其加密后显示。</p>
<p><code>Cycript</code>定位<code>cell</code>获取消息文本内容<br>通过数据线连接到手机</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/wechat3_images/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%87.png?raw=true" width="320" height="568" alt="图片名称" align="center"></p>
<p><code>Cycript</code> 命令如下：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">localhost:</span>python-client Mango<span class="variable">$ </span>ssh root<span class="variable">@localhost</span> -p <span class="number">2222</span></div><div class="line">root<span class="variable">@localhost</span><span class="string">'s password: </span></div><div class="line">wutde-iPhone:~ root# cycript -p WeChat</div></pre></td></tr></table></figure>
<p>然后进入到聊天界面，通过<code>UIApp.keyWindow.recursiveDescription().toString()</code>命令查看道歉界面元素结构</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">cy<span class="comment"># UIApp.keyWindow.recursiveDescription().toString()</span></div><div class="line">`<span class="variable">&lt;iConsoleWindow: 0x14d41990; baseClass = UIWindow; frame = (0 0; 320 568); autoresize = W+H; gestureRecognizers = &lt;NSArray: 0x14d409e0&gt;</span>; layer = <span class="variable">&lt;UIWindowLayer: 0x14d41670&gt;</span>&gt;</div><div class="line">   |<span class="string"> &lt;UILayoutContainerView: 0x161aff80; frame = (0 0; 320 568); autoresize = W+H; layer = &lt;CALayer: 0x163be1a0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string"> &lt;UITransitionView: 0x16768460; frame = (0 0; 320 568); clipsToBounds = YES; autoresize = W+H; layer = &lt;CALayer: 0x163f69c0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIViewControllerWrapperView: 0x163c4780; frame = (0 0; 320 568); autoresize = W+H; layer = &lt;CALayer: 0x16776550&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UILayoutContainerView: 0x1620c680; frame = (0 0; 320 568); autoresize = W+H; gestureRecognizers = &lt;NSArray: 0x160c2fe0&gt;; layer = &lt;CALayer: 0x166664e0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UINavigationTransitionView: 0x162950a0; frame = (0 0; 320 568); clipsToBounds = YES; autoresize = W+H; layer = &lt;CALayer: 0x162c0c10&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIViewControllerWrapperView: 0x1617a840; frame = (0 0; 320 568); layer = &lt;CALayer: 0x16161a20&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIView: 0x163edfa0; frame = (0 0; 320 568); autoresize = W+H; layer = &lt;CALayer: 0x167ba0b0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;MMMultiSelectToolView: 0x16228660; frame = (0 568; 320 50); hidden = YES; layer = &lt;CALayer: 0x162bb220&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x16690f20; frame = (0 0; 320 50); opaque = NO; layer = &lt;CALayer: 0x162d6c20&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIButton: 0x16646da0; frame = (24 7.5; 35 35); opaque = NO; tag = 10002; layer = &lt;CALayer: 0x1627a500&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x160782c0; frame = (0 0; 35 35); clipsToBounds = YES; opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x16078340&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIButton: 0x166e2120; frame = (103 7.5; 35 35); opaque = NO; tag = 10001; layer = &lt;CALayer: 0x166eec20&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x16891d00; frame = (0 0; 35 35); clipsToBounds = YES; opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x1663af20&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIButton: 0x16962c90; frame = (182 7.5; 35 35); opaque = NO; tag = 10003; layer = &lt;CALayer: 0x16962d90&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x168921f0; frame = (0 0; 35 35); clipsToBounds = YES; opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x16891e00&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIButton: 0x1666a6b0; frame = (261 7.5; 35 35); opaque = NO; tag = 10004; layer = &lt;CALayer: 0x166d9060&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x166e8490; frame = (0 0; 35 35); clipsToBounds = YES; opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x166e2f40&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;MMTableView: 0x15bbb400; baseClass = UITableView; frame = (0 0; 320 568); clipsToBounds = YES; gestureRecognizers = &lt;NSArray: 0x16610770&gt;; layer = &lt;CALayer: 0x16832160&gt;; contentOffset: &#123;0, 178&#125;; contentSize: &#123;320, 696&#125;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UITableViewWrapperView: 0x168a4970; frame = (0 0; 320 568); gestureRecognizers = &lt;NSArray: 0x1625c4d0&gt;; layer = &lt;CALayer: 0x162f7920&gt;; contentOffset: &#123;0, 0&#125;; contentSize: &#123;320, 568&#125;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;MultiSelectTableViewCell: 0x1678b220; baseClass = UITableViewCell; frame = (0 163; 320 41); autoresize = W; layer = &lt;CALayer: 0x16348f10&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UITableViewCellContentView: 0x167cf6e0; frame = (0 0; 320 41); gestureRecognizers = &lt;NSArray: 0x16131680&gt;; layer = &lt;CALayer: 0x167cf750&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIView: 0x14d34a60; frame = (0 10; 320 28); layer = &lt;CALayer: 0x14d2c090&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x168ceac0; frame = (139 0; 42 20); opaque = NO; userInteractionEnabled = NO; tag = 87460; layer = &lt;CALayer: 0x16835130&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;MMUILabel: 0x1664cab0; baseClass = UILabel; frame = (139 0; 42 20); text = '14:54'; userInteractionEnabled = NO; tag = 87459; layer = &lt;_UILabelLayer: 0x16615720&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x161316c0; frame = (-27 0; 30 30); hidden = YES; opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x16131740&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;MultiSelectTableViewCell: 0x167ccaa0; baseClass = UITableViewCell; frame = (0 204; 320 62); autoresize = W; tag = 101; layer = &lt;CALayer: 0x167f2ac0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UITableViewCellContentView: 0x167f2b30; frame = (0 0; 320 62); gestureRecognizers = &lt;NSArray: 0x167ccd90&gt;; layer = &lt;CALayer: 0x167ccc40&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;VoiceMessageNodeView: 0x1621bf20; frame = (183 0; 128 59); layer = &lt;CALayer: 0x166581b0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIView: 0x16228e10; frame = (0 0; 80 54); layer = &lt;CALayer: 0x16228e80&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x169834d0; frame = (0 0; 80 54); opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x1699e420&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x16728700; frame = (45.5 14; 12.5 17); opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x16728780&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;MMUILabel: 0x1699e680; baseClass = UILabel; frame = (-17 8; 17 39); text = '2'''; userInteractionEnabled = NO; layer = &lt;_UILabelLayer: 0x1670d090&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIView: 0x16640340; frame = (83 1; 47 47); gestureRecognizers = &lt;NSArray: 0x1662b820&gt;; layer = &lt;CALayer: 0x166402d0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIButton: 0x16674b10; frame = (3 1; 40 40); opaque = NO; tag = 100001; layer = &lt;CALayer: 0x166403b0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x1689fe00; frame = (0 0; 40 40); clipsToBounds = YES; opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x162acf00&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x1662b6c0; frame = (0 0; 46 46); opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x1664fb40&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x167ccde0; frame = (-26.5 8; 30 30); opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x167cce60&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;MultiSelectTableViewCell: 0x167297a0; baseClass = UITableViewCell; frame = (0 594; 320 102); autoresize = W; tag = 101; layer = &lt;CALayer: 0x16729770&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UITableViewCellContentView: 0x16729940; frame = (0 0; 320 102); gestureRecognizers = &lt;NSArray: 0x16740830&gt;; layer = &lt;CALayer: 0x167299b0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;TextMessageNodeView: 0x162048a0; frame = (0 0; 325 99); layer = &lt;CALayer: 0x1665b2a0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIView: 0x168a7150; frame = (55 0; 222 94); layer = &lt;CALayer: 0x168a71c0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x168aa650; frame = (0 0; 222 94); clipsToBounds = YES; opaque = NO; layer = &lt;CALayer: 0x168a9850&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;RichTextView: 0x168a9700; baseClass = UILabel; frame = (19 14; 187 60); opaque = NO; layer = &lt;_UILabelLayer: 0x168a9690&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;_UILabelContentLayer: 0x167d3190&gt; (layer)</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIView: 0x168a5e80; frame = (7 1; 47 47); gestureRecognizers = &lt;NSArray: 0x168a67e0&gt;; layer = &lt;CALayer: 0x168a5e00&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIButton: 0x168a5ef0; frame = (3 1; 40 40); opaque = NO; tag = 100001; layer = &lt;CALayer: 0x168a5ff0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x167f2e20; frame = (0 0; 40 40); clipsToBounds = YES; opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x1670e720&gt;&gt;</span></div></pre></td></tr></table></figure>
<p>从上面打印的信息来看，聊天界面中的<code>cell</code>就是<code>MultiSelectTableViewCell</code> ， 它里面包含着不同的自定义<code>View</code> ,有的是<code>TextMessageNodeView</code> 有的是<code>VoiceMessageNodeView</code> 。 从字面来看文本消息应该对应的是<code>TextMessageNodeView</code> ，音频消息应该对应的是<code>VoiceMessageNodeView</code> 。</p>
<p>下面验证我们的猜测</p>
<p>我们来看一下这条信息：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">	<span class="variable">&lt;MultiSelectTableViewCell: 0x168a4970; baseClass = UITableViewCell; frame = (0 821; 320 102); autoresize = W; tag = 101; layer = &lt;CALayer: 0x168a4b10&gt;</span>&gt;</div><div class="line">	   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UITableViewCellContentView: 0x1689cab0; frame = (0 0; 320 102); gestureRecognizers = &lt;NSArray: 0x168a7350&gt;; layer = &lt;CALayer: 0x1689cb20&gt;&gt;</span></div><div class="line">	   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;TextMessageNodeView: 0x162695f0; frame = (0 0; 325 99); layer = &lt;CALayer: 0x14d2c090&gt;&gt;</span></div><div class="line">	   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIView: 0x161e7710; frame = (55 0; 222 94); layer = &lt;CALayer: 0x16122d00&gt;&gt;</span></div><div class="line">	   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x166e6760; frame = (0 0; 222 94); clipsToBounds = YES; opaque = NO; layer = &lt;CALayer: 0x16275840&gt;&gt;</span></div><div class="line">	   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;RichTextView: 0x16798140; baseClass = UILabel; frame = (19 14; 187 60); opaque = NO; layer = &lt;_UILabelLayer: 0x16725e20&gt;&gt;</span></div><div class="line">	   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;_UILabelContentLayer: 0x163a63d0&gt; (layer)</span></div><div class="line">	   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIView: 0x161186b0; frame = (7 1; 47 47); gestureRecognizers = &lt;NSArray: 0x163d5740&gt;; layer = &lt;CALayer: 0x169a3d50&gt;&gt;</span></div><div class="line">	   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIButton: 0x1631ef80; frame = (3 1; 40 40); opaque = NO; tag = 100001; layer = &lt;CALayer: 0x1679ecd0&gt;&gt;</span></div><div class="line">	   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x16345e10; frame = (0 0; 40 40); clipsToBounds = YES; opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x1670d540&gt;&gt;</span></div><div class="line">	   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x161333e0; frame = (0 0; 46 46); opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x16721ff0&gt;&gt;</span></div><div class="line">	   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x168a73a0; frame = (-26.5 8; 30 30); opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x168a7420&gt;&gt;</span></div><div class="line"></div><div class="line">其中`VoiceMessageNodeView` 的地址是 `0x1621bf20` 我们来改变它的背景颜色来看看界面会不会有变化</div><div class="line"></div><div class="line">cy# #0x162695f0.backgroundColor = [UIColor redColor]</div></pre></td></tr></table></figure>
<p>执行以上命令之后界面中的一个<code>cell</code>变成了红色</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/wechat3_images/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%872.png?raw=true" width="320" height="568" alt="图片名称" align="center"></p>
<p>是的，<code>TextMessageNodeView</code> 就是文本 文本聊天消息上面的自定义<code>view</code> , 其中它里面包含着这个子控件叫<code>RichTextView</code> ，如下：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">RichTextView:</span> <span class="attr">0x16798140</span>; <span class="attr">baseClass</span> = <span class="string">UILabel;</span> <span class="attr">frame</span> = <span class="string">(19</span> <span class="attr">14</span>; <span class="attr">187</span> <span class="attr">60</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">_UILabelLayer:</span> <span class="attr">0x16725e20</span>&gt;</span></span></div></pre></td></tr></table></figure>
<p>它的命名和出现的位置实在是太可疑了，如果不出我们推断它应该就是现实 文本消息的 <code>label</code>，下面证明我们的推断。证明的方式就是通过<code>RichTextView</code> 里面的方法重新给它赋值，使其显示内容改变（方式很多，我想通过重新赋值的方式顺便看看它里面都有哪些方法）。  在之前我们到处我所有头文件中找到<code>RichTextView</code> </p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/wechat3_images/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%873.png?raw=true" alt=""></p>
<p>打开看一下这个头文件的内容：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">@class</span> <span class="title">NSMutableArray</span>, <span class="title">NSString</span>, <span class="title">UIColor</span>, <span class="title">UIFont</span>, <span class="title">UIImage</span>;</span></div><div class="line">	</div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RichTextView</span> : <span class="title">MMCPLabel</span> &lt;<span class="title">TextLayoutDelegate</span>, <span class="title">WCForceTouchPreviewProtocol</span>, <span class="title">WCForceTouchTriggerLongPressProtocol</span>&gt;</span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSMutableArray</span> *_arrParserObjects;</div><div class="line">    <span class="built_in">UIColor</span> *_oNormalBackgroundColor;</div><div class="line">    <span class="built_in">UIColor</span> *_oHighlightedBGColor;</div><div class="line">    <span class="built_in">BOOL</span> _bWholeField;</div><div class="line">    <span class="built_in">BOOL</span> _bHightlighted;</div><div class="line">    <span class="built_in">BOOL</span> _bEnableBGColor;</div><div class="line">    <span class="built_in">UIFont</span> *_oFont;</div><div class="line">    <span class="keyword">float</span> _fWidth;</div><div class="line">    <span class="built_in">UIColor</span> *_oTextColor;</div><div class="line">    <span class="built_in">UIColor</span> *_oTextHLColor;</div><div class="line">    <span class="built_in">NSMutableArray</span> *_arrStyles;</div><div class="line">    <span class="built_in">NSString</span> *_nsContent;</div><div class="line">    <span class="keyword">struct</span> <span class="built_in">CGRect</span> _touchedRect;</div><div class="line">    <span class="built_in">BOOL</span> _bSourceUrlForLP;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> _parserType;</div><div class="line">    <span class="keyword">id</span> &lt;RichTextLayoutDelegate&gt; _layoutDelegate;</div><div class="line">    <span class="keyword">id</span> &lt;ILinkEventExt&gt; _linkDelegate;</div><div class="line">    <span class="built_in">BOOL</span> _bIsLongPressHandled;</div><div class="line">    <span class="built_in">BOOL</span> _bDismissHightLightOutside;</div><div class="line">    <span class="built_in">BOOL</span> _bHandleLongPress;</div><div class="line">    <span class="built_in">BOOL</span> _bHandleTextClick;</div><div class="line">    <span class="built_in">BOOL</span> _bTouchesPassOn;</div><div class="line">    <span class="built_in">UIImage</span> *_oImage;</div><div class="line">    <span class="built_in">BOOL</span> _bTouchBeginOnLink;</div><div class="line">    <span class="built_in">UIColor</span> *_oNormalBGColor;</div><div class="line">&#125;</div><div class="line">	</div><div class="line">+ (<span class="keyword">id</span>)getStyleString:(<span class="keyword">id</span>)arg1 font:(<span class="keyword">id</span>)arg2 width:(<span class="keyword">float</span>)arg3 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg4;</div><div class="line">+ (<span class="keyword">id</span>)getStyleString:(<span class="keyword">id</span>)arg1 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg2;</div><div class="line">+ (<span class="keyword">struct</span> <span class="built_in">CGSize</span>)sizeForPrefixContent:(<span class="keyword">id</span>)arg1 TargetContent:(<span class="keyword">id</span>)arg2 TargetParserString:(<span class="keyword">id</span>)arg3 SuffixContent:(<span class="keyword">id</span>)arg4 font:(<span class="keyword">id</span>)arg5 width:(<span class="keyword">float</span>)arg6 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg7 delegate:(<span class="keyword">id</span>)arg8 outArrStyles:(<span class="keyword">id</span> *)arg9;</div><div class="line">+ (<span class="keyword">struct</span> <span class="built_in">CGSize</span>)sizeForPrefixContent:(<span class="keyword">id</span>)arg1 TargetContent:(<span class="keyword">id</span>)arg2 TargetParserString:(<span class="keyword">id</span>)arg3 SuffixContent:(<span class="keyword">id</span>)arg4 font:(<span class="keyword">id</span>)arg5 width:(<span class="keyword">float</span>)arg6 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg7 delegate:(<span class="keyword">id</span>)arg8;</div></pre></td></tr></table></figure>
<p>在里面找找有没有直接设置text的方法或者属性， 很遗憾没有找到，那就去它的父类<code>MMCPLabel</code> 里面去找，<code>MMCPLabel</code> 的定义如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">@class</span> <span class="title">NSString</span>, <span class="title">UILongPressGestureRecognizer</span>;</span></div><div class="line">	</div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MMCPLabel</span> : <span class="title">MMUILabel</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *m_cpKey;</div><div class="line">    <span class="built_in">UILongPressGestureRecognizer</span> *m_recognizer;</div><div class="line">    <span class="built_in">BOOL</span> _showRestoreMenuItem;</div><div class="line">    <span class="keyword">id</span> &lt;MMCPLabelDelegate&gt; _cpLabelDelegate;</div><div class="line">&#125;</div><div class="line">	</div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) __<span class="keyword">weak</span> <span class="keyword">id</span> &lt;MMCPLabelDelegate&gt; cpLabelDelegate; <span class="comment">// @synthesize cpLabelDelegate=_cpLabelDelegate;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> showRestoreMenuItem; <span class="comment">// @synthesize showRestoreMenuItem=_showRestoreMenuItem;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *cpKey; <span class="comment">// @synthesize cpKey=m_cpKey;</span></div><div class="line">- (<span class="keyword">void</span>).cxx_destruct;</div><div class="line">- (<span class="keyword">struct</span> <span class="built_in">CGSize</span>)sizeThatFits:(<span class="keyword">struct</span> <span class="built_in">CGSize</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)drawLayer:(<span class="keyword">id</span>)arg1 inContext:(<span class="keyword">struct</span> <span class="built_in">CGContext</span> *)arg2;</div><div class="line">- (<span class="keyword">void</span>)layoutSublayersOfLayer:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)handleLongPressGestureRecognizer:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)onRestore:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="built_in">BOOL</span>)canPerformAction:(SEL)arg1 withSender:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="built_in">BOOL</span>)canBecomeFirstResponder;</div><div class="line">- (<span class="keyword">void</span>)setText:(<span class="keyword">id</span>)arg1 highlightKeyWord:(<span class="keyword">id</span>)arg2 range:(<span class="keyword">struct</span> _NSRange)arg3;</div><div class="line">- (<span class="keyword">void</span>)setText:(<span class="keyword">id</span>)arg1 highlightKeyWord:(<span class="keyword">id</span>)arg2 startIndex:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg3;</div><div class="line">- (<span class="keyword">void</span>)setText:(<span class="keyword">id</span>)arg1 highlightKeyWord:(<span class="keyword">id</span>)arg2;</div><div class="line">	</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>其中这几个方法有点可疑：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)<span class="string">setText:</span>(id)arg1 <span class="string">highlightKeyWord:</span>(id)arg2 <span class="string">range:</span>(struct _NSRange)arg3;</div><div class="line">- (<span class="keyword">void</span>)<span class="string">setText:</span>(id)arg1 <span class="string">highlightKeyWord:</span>(id)arg2 <span class="string">startIndex:</span>(unsigned <span class="keyword">int</span>)arg3;</div><div class="line">- (<span class="keyword">void</span>)<span class="string">setText:</span>(id)arg1 <span class="string">highlightKeyWord:</span>(id)arg2;</div></pre></td></tr></table></figure>
<p>好吧，试一下看能不能改变它显示的值。</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cy<span class="meta"># [#0x16798140 setText:@<span class="string">"hello haha"</span> highlightKeyWord:nil]</span></div></pre></td></tr></table></figure>
<p>执行上面命令之后发现界面没有任何的改变。好吧，不是的！！再看看<code>MMCPLabel</code> 的父类 <code>MMUILabel</code>。定义如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">	</div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MMUILabel</span> : <span class="title">UILabel</span></span></div><div class="line">&#123;</div><div class="line">&#125;</div><div class="line">	</div><div class="line">- (<span class="keyword">void</span>)setFrame:(<span class="keyword">struct</span> <span class="built_in">CGRect</span>)arg1;</div><div class="line">- (<span class="keyword">id</span>)initWithFrame:(<span class="keyword">struct</span> <span class="built_in">CGRect</span>)arg1;</div><div class="line">- (<span class="keyword">id</span>)init;</div><div class="line">	</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>好吧，已经追踪到头了，<code>MMUILabel</code> 没有设置的方法，但是它是继承 <code>UILabel</code>的，我们试试UILabel中的text属性看能不能改变其值。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">cy# #<span class="number">0x16798140</span>.<span class="built_in">text</span> = @<span class="string">"hello haha"</span></div><div class="line">@<span class="string">"hello haha"</span></div></pre></td></tr></table></figure>
<p>执行完后界面依然没有任何改变，是不是有点绝望了！ 我把这个掉进坑里的过程写下来，或许大家能够感受到一点点挫折！哈哈，不要灰心，如果没有困难又怎么能体会到成功后的喜悦尼？然我们重新整理思路，再次迎接挑战！</p>
<p>我们再次回到<code>RichTextView</code> 类，然后顺着继承的方向找下去， 认真观察里面的方法， 一定能找到蛛丝马迹让真相大白于天下的。<br>我们把 <code>RichTextView</code> 所有代码（以及100多行）粘出来，谢谢观察一番：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line">	</div><div class="line"><span class="class"><span class="keyword">@class</span> <span class="title">NSMutableArray</span>, <span class="title">NSString</span>, <span class="title">UIColor</span>, <span class="title">UIFont</span>, <span class="title">UIImage</span>;</span></div><div class="line">	</div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RichTextView</span> : <span class="title">MMCPLabel</span> &lt;<span class="title">TextLayoutDelegate</span>, <span class="title">WCForceTouchPreviewProtocol</span>, <span class="title">WCForceTouchTriggerLongPressProtocol</span>&gt;</span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSMutableArray</span> *_arrParserObjects;</div><div class="line">    <span class="built_in">UIColor</span> *_oNormalBackgroundColor;</div><div class="line">    <span class="built_in">UIColor</span> *_oHighlightedBGColor;</div><div class="line">    <span class="built_in">BOOL</span> _bWholeField;</div><div class="line">    <span class="built_in">BOOL</span> _bHightlighted;</div><div class="line">    <span class="built_in">BOOL</span> _bEnableBGColor;</div><div class="line">    <span class="built_in">UIFont</span> *_oFont;</div><div class="line">    <span class="keyword">float</span> _fWidth;</div><div class="line">    <span class="built_in">UIColor</span> *_oTextColor;</div><div class="line">    <span class="built_in">UIColor</span> *_oTextHLColor;</div><div class="line">    <span class="built_in">NSMutableArray</span> *_arrStyles;</div><div class="line">    <span class="built_in">NSString</span> *_nsContent;</div><div class="line">    <span class="keyword">struct</span> <span class="built_in">CGRect</span> _touchedRect;</div><div class="line">    <span class="built_in">BOOL</span> _bSourceUrlForLP;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> _parserType;</div><div class="line">    <span class="keyword">id</span> &lt;RichTextLayoutDelegate&gt; _layoutDelegate;</div><div class="line">    <span class="keyword">id</span> &lt;ILinkEventExt&gt; _linkDelegate;</div><div class="line">    <span class="built_in">BOOL</span> _bIsLongPressHandled;</div><div class="line">    <span class="built_in">BOOL</span> _bDismissHightLightOutside;</div><div class="line">    <span class="built_in">BOOL</span> _bHandleLongPress;</div><div class="line">    <span class="built_in">BOOL</span> _bHandleTextClick;</div><div class="line">    <span class="built_in">BOOL</span> _bTouchesPassOn;</div><div class="line">    <span class="built_in">UIImage</span> *_oImage;</div><div class="line">    <span class="built_in">BOOL</span> _bTouchBeginOnLink;</div><div class="line">    <span class="built_in">UIColor</span> *_oNormalBGColor;</div><div class="line">&#125;</div><div class="line">	</div><div class="line">+ (<span class="keyword">id</span>)getStyleString:(<span class="keyword">id</span>)arg1 font:(<span class="keyword">id</span>)arg2 width:(<span class="keyword">float</span>)arg3 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg4;</div><div class="line">+ (<span class="keyword">id</span>)getStyleString:(<span class="keyword">id</span>)arg1 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg2;</div><div class="line">+ (<span class="keyword">struct</span> <span class="built_in">CGSize</span>)sizeForPrefixContent:(<span class="keyword">id</span>)arg1 TargetContent:(<span class="keyword">id</span>)arg2 TargetParserString:(<span class="keyword">id</span>)arg3 SuffixContent:(<span class="keyword">id</span>)arg4 font:(<span class="keyword">id</span>)arg5 width:(<span class="keyword">float</span>)arg6 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg7 delegate:(<span class="keyword">id</span>)arg8 outArrStyles:(<span class="keyword">id</span> *)arg9;</div><div class="line">+ (<span class="keyword">struct</span> <span class="built_in">CGSize</span>)sizeForPrefixContent:(<span class="keyword">id</span>)arg1 TargetContent:(<span class="keyword">id</span>)arg2 TargetParserString:(<span class="keyword">id</span>)arg3 SuffixContent:(<span class="keyword">id</span>)arg4 font:(<span class="keyword">id</span>)arg5 width:(<span class="keyword">float</span>)arg6 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg7 delegate:(<span class="keyword">id</span>)arg8;</div><div class="line">+ (<span class="keyword">float</span>)heightForPrefixContent:(<span class="keyword">id</span>)arg1 TargetContent:(<span class="keyword">id</span>)arg2 TargetParserString:(<span class="keyword">id</span>)arg3 SuffixContent:(<span class="keyword">id</span>)arg4 font:(<span class="keyword">id</span>)arg5 width:(<span class="keyword">float</span>)arg6 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg7 delegate:(<span class="keyword">id</span>)arg8 outArrStyles:(<span class="keyword">id</span> *)arg9;</div><div class="line">+ (<span class="keyword">float</span>)heightForPrefixContent:(<span class="keyword">id</span>)arg1 TargetContent:(<span class="keyword">id</span>)arg2 TargetParserString:(<span class="keyword">id</span>)arg3 SuffixContent:(<span class="keyword">id</span>)arg4 font:(<span class="keyword">id</span>)arg5 width:(<span class="keyword">float</span>)arg6 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg7 delegate:(<span class="keyword">id</span>)arg8;</div><div class="line">+ (<span class="keyword">id</span>)getParserString:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getParserString:(<span class="keyword">id</span>)arg1 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg2;</div><div class="line">+ (<span class="keyword">id</span>)getStyleString:(<span class="keyword">id</span>)arg1 font:(<span class="keyword">id</span>)arg2 width:(<span class="keyword">float</span>)arg3 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg4 delegate:(<span class="keyword">id</span>)arg5;</div><div class="line">+ (<span class="keyword">float</span>)getHeightForContent:(<span class="keyword">id</span>)arg1 font:(<span class="keyword">id</span>)arg2 width:(<span class="keyword">float</span>)arg3 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg4 delegate:(<span class="keyword">id</span>)arg5 outArrStyles:(<span class="keyword">id</span> *)arg6;</div><div class="line">+ (<span class="keyword">float</span>)getHeightForContent:(<span class="keyword">id</span>)arg1 font:(<span class="keyword">id</span>)arg2 width:(<span class="keyword">float</span>)arg3 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg4 delegate:(<span class="keyword">id</span>)arg5;</div><div class="line">+ (<span class="keyword">float</span>)getHeightForContent:(<span class="keyword">id</span>)arg1 font:(<span class="keyword">id</span>)arg2 width:(<span class="keyword">float</span>)arg3 parserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg4;</div><div class="line">+ (<span class="keyword">void</span>)initialize;</div><div class="line">+ (<span class="keyword">id</span>)pureStringForContent:(<span class="keyword">id</span>)arg1;</div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> bTouchBeginOnLink; <span class="comment">// @synthesize bTouchBeginOnLink=_bTouchBeginOnLink;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSMutableArray</span> *arrStyles; <span class="comment">// @synthesize arrStyles=_arrStyles;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) __<span class="keyword">weak</span> <span class="keyword">id</span> &lt;ILinkEventExt&gt; linkDelegate; <span class="comment">// @synthesize linkDelegate=_linkDelegate;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> bTouchesPassOn; <span class="comment">// @synthesize bTouchesPassOn=_bTouchesPassOn;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> bDismissHightLightOutside; <span class="comment">// @synthesize bDismissHightLightOutside=_bDismissHightLightOutside;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> bEnableBGColor; <span class="comment">// @synthesize bEnableBGColor=_bEnableBGColor;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">UIColor</span> *oHighlightedBGColor; <span class="comment">// @synthesize oHighlightedBGColor=_oHighlightedBGColor;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">UIColor</span> *oNormalBGColor; <span class="comment">// @synthesize oNormalBGColor=_oNormalBGColor;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> bSourceUrlForLP; <span class="comment">// @synthesize bSourceUrlForLP=_bSourceUrlForLP;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> bHandleTextClick; <span class="comment">// @synthesize bHandleTextClick=_bHandleTextClick;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> bHandleLongPress; <span class="comment">// @synthesize bHandleLongPress=_bHandleLongPress;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) __<span class="keyword">weak</span> <span class="keyword">id</span> &lt;RichTextLayoutDelegate&gt; layoutDelegate; <span class="comment">// @synthesize layoutDelegate=_layoutDelegate;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">int</span> parserType; <span class="comment">// @synthesize parserType=_parserType;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">float</span> fWidth; <span class="comment">// @synthesize fWidth=_fWidth;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">UIFont</span> *oFont; <span class="comment">// @synthesize oFont=_oFont;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">UIColor</span> *oTextHLColor; <span class="comment">// @synthesize oTextHLColor=_oTextHLColor;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">UIColor</span> *oTextColor; <span class="comment">// @synthesize oTextColor=_oTextColor;</span></div><div class="line">- (<span class="keyword">void</span>).cxx_destruct;</div><div class="line">- (<span class="keyword">void</span>)addStylesParserByPatternString:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">struct</span> <span class="built_in">CGRect</span>)getPreviewLinkFrameForLocation:(<span class="keyword">struct</span> <span class="built_in">CGPoint</span>)arg1 inView:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">id</span>)getPreviewLinkForLocation:(<span class="keyword">struct</span> <span class="built_in">CGPoint</span>)arg1 inView:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">struct</span> <span class="built_in">CGRect</span>)previewingSourceRectForLocation:(<span class="keyword">struct</span> <span class="built_in">CGPoint</span>)arg1 inCoordinateView:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">id</span>)viewControllerToPreviewWithFromController:(<span class="keyword">id</span>)arg1 forLocation:(<span class="keyword">struct</span> <span class="built_in">CGPoint</span>)arg2 inCoordinateView:(<span class="keyword">id</span>)arg3;</div><div class="line">- (<span class="built_in">BOOL</span>)canPeek;</div><div class="line">- (<span class="keyword">void</span>)updateAccessibilityLabel;</div><div class="line">- (<span class="keyword">void</span>)touchesCancelled:(<span class="keyword">id</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)touchesEnded:(<span class="keyword">id</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)delayedTouchesEnded:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)triggerLongPressFor3DTouchAtLocation:(<span class="keyword">struct</span> <span class="built_in">CGPoint</span>)arg1 inCoordinateView:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="keyword">id</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="built_in">BOOL</span>)pointInside:(<span class="keyword">struct</span> <span class="built_in">CGPoint</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)longPressOnTextEvent:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)clickOnTextEvent:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)longPressOnPhoneEvent:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)longPressOnLinkEvent:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)clickOnPhoneEvent:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)clickOnLinkEvent:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)drawRect:(<span class="keyword">struct</span> <span class="built_in">CGRect</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)dismissHighLight;</div><div class="line">- (<span class="built_in">BOOL</span>)setContent:(<span class="keyword">id</span>)arg1 StyleString:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="built_in">BOOL</span>)setPrefixContent:(<span class="keyword">id</span>)arg1 TargetContent:(<span class="keyword">id</span>)arg2 TargetParserString:(<span class="keyword">id</span>)arg3 SuffixContent:(<span class="keyword">id</span>)arg4;</div><div class="line">- (<span class="built_in">BOOL</span>)getStylesForContent:(<span class="keyword">id</span>)arg1 parserString:(<span class="keyword">id</span>)arg2 parserPosition:(<span class="keyword">struct</span> _NSParserPosition)arg3;</div><div class="line">- (<span class="keyword">id</span>)getParserString:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">id</span>)getStyleString:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">id</span>)getPatternStringFromContent:(<span class="keyword">id</span>)arg1 patternGenerator:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">id</span>)getParserByPaserType:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg1;</div><div class="line">- (<span class="built_in">BOOL</span>)shouldOpenNewLineAtY:(<span class="keyword">float</span>)arg1 withLineHeight:(<span class="keyword">float</span>)arg2;</div><div class="line">- (<span class="keyword">float</span>)originXForLineAtHeight:(<span class="keyword">float</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)setContent:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">id</span>)createParser:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)updateFrame:(<span class="keyword">float</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)resetFrameForMinHeight:(<span class="keyword">float</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)setArrStyles:(<span class="keyword">id</span>)arg1 withContent:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">id</span>)initWithCoder:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">id</span>)initWithFrame:(<span class="keyword">struct</span> <span class="built_in">CGRect</span>)arg1;</div><div class="line">- (<span class="keyword">id</span>)init;</div><div class="line">- (<span class="keyword">void</span>)baseInit;</div><div class="line">	</div><div class="line"><span class="comment">// Remaining properties</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *debugDescription;</div><div class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *description;</div><div class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>) <span class="keyword">unsigned</span> <span class="keyword">int</span> hash;</div><div class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>) Class superclass;</div><div class="line">	</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>其中有个方法 <code>- (void)setContent:(id)arg1</code>有没有感觉很可疑的样子。“设置内容”这名字跟隔壁老王太像了。推断其参数就是NSString.下面验证我们的推断：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">cy<span class="comment"># [#0x1665cc50 setContent:@"i found you"]</span></div></pre></td></tr></table></figure>
<p>界面变成了</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/wechat3_images/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%874.png?raw=true" width="320" height="568" alt="图片名称" align="center"></p>
<p>好了，终于成功了！有朋友可能开始想了，能不能通过<code>hook</code>  <code>RichTextView</code> 的<code>setContent</code>对消息进行加密后重新赋值？理论上是可以的，但是消息的内容不应该在view中修改，view只管显示，而且这里的<code>view</code>是<code>cell</code>的子类，还要考虑<code>cell</code>复用的问题！ 所以我还是打算从model的角度去加密消息，因为每一个序号下的cell对应一个唯一的<code>Model</code>.</p>
<p>聊天界面控制器<code>BaseMsgContentViewController</code></p>
<p>寻找当前控制器的方式前面已经讲过很多，当前的tablevView信息如下：</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span></div><div class="line"><span class="tag">&lt;<span class="name">MMTableView:</span> <span class="attr">0x15341e00</span>; <span class="attr">baseClass</span> = <span class="string">UITableView;</span> <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">320</span> <span class="attr">568</span>); <span class="attr">clipsToBounds</span> = <span class="string">YES;</span> <span class="attr">gestureRecognizers</span> = &lt;<span class="attr">NSArray:</span> <span class="attr">0x16105240</span>&gt;</span>; layer = <span class="tag">&lt;<span class="name">CALayer:</span> <span class="attr">0x1611d6f0</span>&gt;</span>; contentOffset: <span class="template-variable">&#123;0, 774&#125;</span><span class="xml">; contentSize: </span><span class="template-variable">&#123;320, 1292&#125;</span><span class="xml">&gt;</span></div><div class="line"></div><div class="line">	</div><div class="line">cy# [#0x15341e00 nextResponder]</div><div class="line">#"<span class="tag">&lt;<span class="name">UIView:</span> <span class="attr">0x16642230</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">320</span> <span class="attr">568</span>); <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x16098ff0</span>&gt;</span>&gt;"</div><div class="line">cy# [#0x16642230 nextResponder]</div><div class="line">#"<span class="tag">&lt;<span class="name">BaseMsgContentViewController:</span> <span class="attr">0x15c39200</span>&gt;</span>"</div></pre></td></tr></table></figure>
<p><code>BaseMsgContentViewController</code>就是当前界面的控制器</p>
<p><code>TextMessageNodeView</code>深究<br>好了，现在我们来深究一下<code>TextMessageNodeView</code> 。我们知道聊天界面的<code>cell</code>就是<code>MultiSelectTableViewCell</code> 根据消息类型的不同其子控件有 <code>TextMessageNodeView</code> 和<code>VoiceMessageNodeView</code> 等。因为每一个<code>model</code>都对应一个<code>cell</code>,所以我可以推测出 <code>TextMessageNodeView</code> 应该绑定着文本消息model 而<code>VoiceMessageNodeView</code> 应该绑定着录音消息<code>model</code> 。下面我们先从<code>TextMessageNodeView</code> 进行切入。</p>
<p>我们打开<code>TextMessageNodeView</code> 头文件，里面的代码像这样的：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">	</div><div class="line"><span class="class"><span class="keyword">@class</span> <span class="title">InteractionLabel</span>, <span class="title">MMTipsViewController</span>, <span class="title">MMUILabel</span>, <span class="title">NSString</span>, <span class="title">RichTextView</span>, <span class="title">TextFloatPreview</span>, <span class="title">UIButton</span>, <span class="title">UIImageView</span>, <span class="title">UIView</span>, <span class="title">WCUIActionSheet</span>;</span></div><div class="line">	</div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TextMessageNodeView</span> : <span class="title">BaseMessageNodeView</span> &lt;<span class="title">WCActionSheetDelegate</span>, <span class="title">RichTextLayoutDelegate</span>, <span class="title">ILinkEventExt</span>, <span class="title">IMsgRevokeExt</span>, <span class="title">TextFloatPreviewDelegate</span>, <span class="title">UIAlertViewDelegate</span>, <span class="title">ITranslateMsgMgrExt</span>, <span class="title">MMTipsViewControllerDelegate</span>&gt;</span></div><div class="line">&#123;</div><div class="line">    RichTextView *m_oRichTextView;</div><div class="line">    TextFloatPreview *m_floatPreview;</div><div class="line">    <span class="built_in">UIView</span> *m_oContainerTextView;</div><div class="line">    <span class="built_in">UIImageView</span> *m_oTranslateLineView;</div><div class="line">    <span class="built_in">UIButton</span> *m_oTranslateStatusButton;</div><div class="line">    <span class="built_in">BOOL</span> m_bTranslateAnimation;</div><div class="line">    MMTipsViewController *m_oTranslateIntroView;</div><div class="line">    WCUIActionSheet *_uiActionSheet;</div><div class="line">    MMUILabel *_labelTitle;</div><div class="line">    <span class="built_in">UIView</span> *_labelTitleLine;</div><div class="line">    <span class="built_in">BOOL</span> _bShowFullText;</div><div class="line">    <span class="keyword">float</span> _fulltextHeight;</div><div class="line">    <span class="keyword">float</span> _limitHeight;</div><div class="line">    InteractionLabel *_fullTextLabel;</div><div class="line">&#125;</div><div class="line">	</div><div class="line">+ (<span class="built_in">BOOL</span>)canCreateMessageNodeViewInstanceWithMessageWrap:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>).cxx_destruct;</div><div class="line">- (<span class="keyword">struct</span> <span class="built_in">CGRect</span>)previewingSourceRectForLocation:(<span class="keyword">struct</span> <span class="built_in">CGPoint</span>)arg1 inCoordinateView:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">id</span>)viewControllerToPreviewWithFromController:(<span class="keyword">id</span>)arg1 forLocation:(<span class="keyword">struct</span> <span class="built_in">CGPoint</span>)arg2 inCoordinateView:(<span class="keyword">id</span>)arg3;</div><div class="line">- (<span class="built_in">BOOL</span>)canPeek;</div><div class="line">- (<span class="keyword">void</span>)onPhoneClicked:(<span class="keyword">id</span>)arg1 withRect:(<span class="keyword">struct</span> <span class="built_in">CGRect</span>)arg2;</div><div class="line">- (<span class="keyword">id</span>)getMoreMainInfomationAccessibilityDescription;</div><div class="line">- (<span class="keyword">void</span>)triggerLongPressFor3DTouchAtLocation:(<span class="keyword">struct</span> <span class="built_in">CGPoint</span>)arg1 inCoordinateView:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="built_in">BOOL</span>)shouldOpenNewLineAtY:(<span class="keyword">float</span>)arg1 withLineHeight:(<span class="keyword">float</span>)arg2 richTextView:(<span class="keyword">id</span>)arg3;</div><div class="line">- (<span class="keyword">void</span>)onLinkClicked:(<span class="keyword">id</span>)arg1 withRect:(<span class="keyword">struct</span> <span class="built_in">CGRect</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)onTranslateMessageFailed:(<span class="keyword">id</span>)arg1 errTip:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)handleChangeForTranslateMsg;</div><div class="line">- (<span class="keyword">void</span>)resizeFrameForTranslate;</div><div class="line">- (<span class="keyword">void</span>)onTranslateMessageChanged:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)onClickTipsBtn:(<span class="keyword">unsigned</span> <span class="keyword">int</span>)arg1;</div><div class="line">- (<span class="keyword">id</span>)patternText;</div><div class="line">- (<span class="keyword">id</span>)titleText;</div><div class="line">- (<span class="keyword">id</span>)bigTitleText;</div><div class="line">- (<span class="keyword">id</span>)getContactDisplayName:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)dealloc;</div><div class="line">- (<span class="keyword">void</span>)onMenuItemWillHide;</div><div class="line">- (<span class="keyword">void</span>)onTouchCancel;</div><div class="line">- (<span class="keyword">void</span>)onLongTouch;</div><div class="line">- (<span class="keyword">void</span>)onTouchUpInside;</div><div class="line">- (<span class="keyword">void</span>)onHide;</div><div class="line">- (<span class="keyword">void</span>)onWindowHide;</div><div class="line">- (<span class="keyword">void</span>)onTouchDownRepeat;</div><div class="line">- (<span class="keyword">void</span>)onTouchDown;</div><div class="line">- (<span class="keyword">void</span>)alertView:(<span class="keyword">id</span>)arg1 clickedButtonAtIndex:(<span class="keyword">int</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)OnMsgRevoked:(<span class="keyword">id</span>)arg1 n64MsgId:(<span class="keyword">long</span> <span class="keyword">long</span>)arg2 SysMsg:(<span class="keyword">id</span>)arg3;</div><div class="line">- (<span class="keyword">id</span>)accessibilityLabel;</div><div class="line">- (<span class="built_in">BOOL</span>)isAccessibilityElement;</div><div class="line">- (<span class="keyword">void</span>)onMoreOperate:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)addFavorite;</div><div class="line">- (<span class="keyword">void</span>)onFavoriteAdd:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)onCopy:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)onForward:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)onTranslateMsg:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)translateMsg;</div><div class="line">- (<span class="built_in">BOOL</span>)isSupportingTranslation;</div><div class="line">- (<span class="keyword">void</span>)updateSubviewsForTranslate;</div><div class="line">- (<span class="keyword">void</span>)onStopTranslateAnimation;</div><div class="line">- (<span class="keyword">void</span>)initTranslateStatusButton;</div><div class="line">- (<span class="keyword">void</span>)reLayoutSubviews;</div><div class="line">- (<span class="built_in">BOOL</span>)canShowTranslateBottomView;</div><div class="line">- (<span class="keyword">void</span>)showOpearation;</div><div class="line">- (<span class="keyword">void</span>)onOrientationChanged;</div><div class="line">- (<span class="keyword">void</span>)actionSheet:(<span class="keyword">id</span>)arg1 didDismissWithButtonIndex:(<span class="keyword">int</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)actionSheet:(<span class="keyword">id</span>)arg1 clickedButtonAtIndex:(<span class="keyword">int</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)onLinkLongPressed:(<span class="keyword">id</span>)arg1 withRect:(<span class="keyword">struct</span> <span class="built_in">CGRect</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)onCopyLinkText:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="built_in">BOOL</span>)onlyContainsLink;</div><div class="line">- (<span class="keyword">struct</span> <span class="built_in">CGRect</span>)getPreviewLinkFrameForLocation:(<span class="keyword">struct</span> <span class="built_in">CGPoint</span>)arg1 inView:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">id</span>)getPreviewLinkForLocation:(<span class="keyword">struct</span> <span class="built_in">CGPoint</span>)arg1 inView:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)layoutSubviewsInternal;</div><div class="line">- (<span class="keyword">float</span>)calculateTranslatedRichTextWidth;</div><div class="line">- (<span class="keyword">float</span>)calculateOriginRichTextHeight;</div><div class="line">- (<span class="built_in">BOOL</span>)shouldShowTranslatedText;</div><div class="line">- (<span class="keyword">void</span>)setRichtextViewContent;</div><div class="line">- (<span class="keyword">void</span>)updateSubviews;</div><div class="line">- (<span class="keyword">void</span>)updateBkgImage:(<span class="built_in">BOOL</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)updateFrameForShowFullText;</div><div class="line">- (<span class="keyword">void</span>)showFullText;</div><div class="line">- (<span class="keyword">struct</span> <span class="built_in">CGSize</span>)sizeForFullTextLabel;</div><div class="line">- (<span class="keyword">struct</span> <span class="built_in">CGSize</span>)sizeForFrame:(<span class="keyword">struct</span> <span class="built_in">CGRect</span>)arg1;</div><div class="line">- (<span class="keyword">void</span>)initLabelTitle;</div><div class="line">- (<span class="keyword">float</span>)labelWidth;</div><div class="line">- (<span class="keyword">void</span>)updateStatus:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">id</span>)getSystemFont;</div><div class="line">- (<span class="keyword">id</span>)initWithMessageWrap:(<span class="keyword">id</span>)arg1 Contact:(<span class="keyword">id</span>)arg2 ChatContact:(<span class="keyword">id</span>)arg3;</div><div class="line">	</div><div class="line"><span class="comment">// Remaining properties</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *debugDescription;</div><div class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *description;</div><div class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>) <span class="keyword">unsigned</span> <span class="keyword">int</span> hash;</div><div class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>) Class superclass;</div><div class="line">	</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>是不是已经发现让你兴奋的东西啦</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (<span class="name">void</span>)onMenuItemWillHide<span class="comment">;</span></div><div class="line">- (<span class="name">void</span>)onTouchCancel<span class="comment">;</span></div><div class="line">- (<span class="name">void</span>)onLongTouch<span class="comment">;</span></div><div class="line">- (<span class="name">void</span>)onTouchUpInside<span class="comment">;</span></div><div class="line">- (<span class="name">void</span>)onHide<span class="comment">;</span></div><div class="line">- (<span class="name">void</span>)onWindowHide<span class="comment">;</span></div><div class="line">- (<span class="name">void</span>)onTouchDownRepeat<span class="comment">;</span></div><div class="line">- (<span class="name">void</span>)onTouchDown<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>这几个方法也太明显了，还是那句话，有屁股都能想到是干嘛的！但是我们还是要验证一下：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cy<span class="meta"># [#0x167929a0 onLongTouch]</span></div></pre></td></tr></table></figure>
<p>执行上面的命令后<code>cell</code>弹出了菜单</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/wechat3_images/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%875.png?raw=true" width="320" height="568" alt="图片名称" align="center"></p>
<p>我们再调用一下双击的方法试试：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cy<span class="meta"># [#0x167929a0 onTouchDownRepeat]</span></div></pre></td></tr></table></figure>
<p>界面变成了这样：</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/wechat3_images/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%876.png?raw=true" width="320" height="568" alt="图片名称" align="center"></p>
<p>因为之前我们仅仅是改变了 <code>cell</code> 上 <code>RichTextView</code> 的显示，而没有改变<code>model</code>中的值，所以这里又显示回了原来的值而不是<code>“I found you”</code>，这就是之前我们所说的为什么不通过hook <code>RichTextView</code> 的 <code>setContent</code>方法来加密的原因之一了。</p>
<p>我们在看看<code>TextMessageNodeView</code> 类，看看里面有没有绑定<code>messageModel</code> 。<code>TextMessageNodeView</code> 没有找到，我们就看看其父类<code>BaseMessageNodeView</code>，它头文件中的代码如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@interface <span class="keyword">BaseMessageNodeView </span>: MMUIView &lt;IHeadImageExt, IContactMgrExt, IQQContactMgrExt, IStrangerContactMgrExt, WCActionSheetDelegate, IAppDataExt, MMIconActionSheetDelegate, EmoticonDescMgrExt, IKFContactExt, IEnterpriseContactMgrExt, UIViewForceTouchShakeProtocol, WCForceTouchPreviewProtocol, WCForceTouchTriggerLongPressProtocol&gt;</div><div class="line">&#123;</div><div class="line">    CMessageWrap *m_oMessageWrap<span class="comment">;</span></div><div class="line">    CBaseContact *m_oContact<span class="comment">;</span></div><div class="line">    CBaseContact *m_oChatContact<span class="comment">;</span></div><div class="line">    id &lt;messageNodeViewDelegate&gt; m_delegate<span class="comment">;</span></div><div class="line">    unsigned long m_uiTouchBeginTime<span class="comment">;</span></div><div class="line">    <span class="keyword">BOOL </span>m_bIsLongPressHandled<span class="comment">;</span></div><div class="line">    unsigned long m_eNodeType<span class="comment">;</span></div><div class="line">    UIView *m_oContentView<span class="comment">;</span></div><div class="line">    UIView *m_oHeadImageView<span class="comment">;</span></div><div class="line">    UIButton *m_oCommentButton<span class="comment">;</span></div><div class="line">    MMCPLabel *m_oChatRoomNameLabel<span class="comment">;</span></div><div class="line">    UIImageView *m_oBkgImageView<span class="comment">;</span></div><div class="line">    <span class="keyword">BOOL </span>m_bHasLayout<span class="comment">;</span></div><div class="line">    float m_lastScreenWidth<span class="comment">;</span></div><div class="line">    float m_fContentViewLeftMargin<span class="comment">;</span></div><div class="line">    float m_fContentViewRightMargin<span class="comment">;</span></div><div class="line">    int m_orientation<span class="comment">;</span></div><div class="line">    NSArray *m_arrMenuItems<span class="comment">;</span></div><div class="line">    UIButton *m_oSendFailButton<span class="comment">;</span></div><div class="line">    UIImageView *m_oSendOKView<span class="comment">;</span></div><div class="line">    UIActivityIndicatorView *m_oActivityIndicator<span class="comment">;</span></div><div class="line">    UIButton *m_oAppBottomButton<span class="comment">;</span></div><div class="line">    AppMessageBlockButton *m_oAppMessageBlockButton<span class="comment">;</span></div><div class="line">    <span class="keyword">BOOL </span>m_donorIconHidden<span class="comment">;</span></div><div class="line">    <span class="keyword">BOOL </span>m_bSendOKShowAnimate<span class="comment">;</span></div><div class="line">    float m_fHeightInSizeForFrame<span class="comment">;</span></div><div class="line">    <span class="keyword">BOOL </span>m_bMenuVC<span class="comment">;</span></div><div class="line">    MMIconActionSheet *m_iconActionSheet<span class="comment">;</span></div><div class="line">    NSString *m_cpKeyForChatRoomMessage<span class="comment">;</span></div><div class="line">    <span class="keyword">BOOL </span>m_isChatRoomMessageUnsafe<span class="comment">;</span></div><div class="line">    <span class="keyword">BOOL </span>m_touchEnded<span class="comment">;</span></div><div class="line">    CTRichTextView *m_crashWarningLabel<span class="comment">;</span></div><div class="line">    NSString *m_cpKeyForChatRoomDisplayName<span class="comment">;</span></div><div class="line">    <span class="keyword">BOOL </span>m_isChatRoomDisplayNameUnsafe<span class="comment">;</span></div><div class="line">    <span class="keyword">BOOL </span>m_isConverting3dTouchToLongPress<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好吧，第一个属性 <code>m_oMessageWrap</code>看上去很可疑，它或许就是我们一直要找的绑定在 <code>cell</code>上面的<code>model</code>，我们来看看它的头文件都有啥（复制的部分内容）：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div></pre></td><td class="code"><pre><div class="line">	</div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CMessageWrap</span> : <span class="title">MMObject</span> &lt;<span class="title">IAppMsgPathMgr</span>, <span class="title">ISysNewXmlMsgExtendOperation</span>, <span class="title">IMsgExtendOperation</span>, <span class="title">NSCopying</span>&gt;</span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">BOOL</span> m_bIsSplit;</div><div class="line">    <span class="built_in">BOOL</span> m_bNew;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiMesLocalID;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> m_n64MesSvrID;</div><div class="line">    <span class="built_in">NSString</span> *m_nsFromUsr;</div><div class="line">    <span class="built_in">NSString</span> *m_nsToUsr;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiMessageType;</div><div class="line">    <span class="built_in">NSString</span> *m_nsContent;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiStatus;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiImgStatus;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiMsgFlag;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiCreateTime;</div><div class="line">    <span class="built_in">NSString</span> *m_nsPushContent;</div><div class="line">    <span class="built_in">NSString</span> *m_nsMsgSource;</div><div class="line">    <span class="built_in">NSString</span> *m_nsRealChatUsr;</div><div class="line">    <span class="built_in">NSData</span> *m_dtThumbnail;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiSendTime;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiEmojiStatFlag;</div><div class="line">    <span class="built_in">NSString</span> *m_nsPattern;</div><div class="line">    <span class="built_in">BOOL</span> m_bForward;</div><div class="line">    <span class="built_in">BOOL</span> m_bCdnForward;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiPercent;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiDownloadStatus;</div><div class="line">    <span class="keyword">id</span> &lt;IMsgExtendOperation&gt; m_extendInfoWithMsgTypeForBiz;</div><div class="line">    <span class="keyword">id</span> &lt;IMsgExtendOperation&gt; m_extendInfoWithMsgType;</div><div class="line">    <span class="keyword">id</span> &lt;IMsgExtendOperation&gt; m_extendInfoWithFromUsr;</div><div class="line">    <span class="built_in">NSString</span> *m_nsLastDisplayContent;</div><div class="line">    <span class="built_in">BOOL</span> m_isTempSessionMsg;</div><div class="line">    <span class="built_in">BOOL</span> m_isEnterpriseMsg;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m_sequenceId;</div><div class="line">    <span class="built_in">NSString</span> *m_nsKFWorkerOpenID;</div><div class="line">    <span class="built_in">NSString</span> *m_nsBizClientMsgID;</div><div class="line">    <span class="built_in">NSString</span> *m_nsBizChatId;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiBizChatVer;</div><div class="line">    <span class="built_in">NSString</span> *m_nsAtUserList;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> watchMsgSourceType;</div><div class="line">    <span class="built_in">NSString</span> *m_nsDisplayName;</div><div class="line">&#125;</div><div class="line">	</div><div class="line">+ (<span class="keyword">id</span>)createMaskedThumbImageForMessageWrap:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)GetCdnDownloadPathOfMsgThumb:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)GetTempPathOfMesShortVideoWithMessageWrap:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)GetPathOfMesVideoWithMessageWrap:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getMaskedMsgImgThumb:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getMsgImgThumb:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getPathOfVideoMsgImgThumb:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)GetPathOfMaskedSquareMesImgThumbDir:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)GetPathOfSquareMesImgThumb:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getPathOfMaskedMsgImgThumb:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getPathOfMessageImageCache;</div><div class="line">+ (<span class="keyword">id</span>)getOldPathOfMessageImageCache;</div><div class="line">+ (<span class="keyword">id</span>)getPathOfMsgImgThumb:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getMsgImgData:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getMsgImg:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getPathOfMsgImg:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getMsgHDImgData:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getMsgHDImg:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getPathOfMsgHDImg:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)getUserNameFromMsgWrap:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="built_in">BOOL</span>)isSenderFromMsgWrap:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="built_in">BOOL</span>)IsRecordMsg:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="built_in">BOOL</span>)SaveMesImg:(<span class="keyword">id</span>)arg1 MsgWrap:(<span class="keyword">id</span>)arg2;</div><div class="line">+ (<span class="built_in">BOOL</span>)SaveMsgThumbWithMsgWrap:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">void</span>)clearLocalMaskedThumbImage:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">void</span>)clearLocalImage:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)FormMessageWrapFromAddMsg:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">id</span>)FormMessageWrapFromBuffer:(<span class="keyword">id</span>)arg1;</div><div class="line">+ (<span class="keyword">void</span>)initialize;</div><div class="line">+ (<span class="keyword">void</span>)GetPathOfAppRemindAttach:(<span class="keyword">id</span>)arg1 retStrPath:(<span class="keyword">id</span> *)arg2;</div><div class="line">+ (<span class="keyword">void</span>)GetPathOfAppThumb:(<span class="keyword">id</span>)arg1 LocalID:(<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg2 retStrPath:(<span class="keyword">id</span> *)arg3;</div><div class="line">+ (<span class="keyword">void</span>)GetPathOfMaskedAppThumb:(<span class="keyword">id</span>)arg1 LocalID:(<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg2 retStrPath:(<span class="keyword">id</span> *)arg3;</div><div class="line">+ (<span class="keyword">void</span>)GetPathOfAppDataTemp:(<span class="keyword">id</span>)arg1 LocalID:(<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg2 retStrPath:(<span class="keyword">id</span> *)arg3;</div><div class="line">+ (<span class="keyword">void</span>)GetPathOfAppDataTemp:(<span class="keyword">id</span>)arg1 LocalID:(<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg2 AttachId:(<span class="keyword">id</span>)arg3 retStrPath:(<span class="keyword">id</span> *)arg4;</div><div class="line">+ (<span class="keyword">void</span>)GetPathOfAppDataByUserName:(<span class="keyword">id</span>)arg1 andMessageWrap:(<span class="keyword">id</span>)arg2 retStrPath:(<span class="keyword">id</span> *)arg3;</div><div class="line">+ (<span class="keyword">void</span>)GetPathOfAppDataByUserName:(<span class="keyword">id</span>)arg1 andMessageWrap:(<span class="keyword">id</span>)arg2 andAttachId:(<span class="keyword">id</span>)arg3 andAttachFileExt:(<span class="keyword">id</span>)arg4 retStrPath:(<span class="keyword">id</span> *)arg5;</div><div class="line">+ (<span class="keyword">void</span>)GetPathOfAppData:(<span class="keyword">id</span>)arg1 LocalID:(<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg2 FileExt:(<span class="keyword">id</span>)arg3 retStrPath:(<span class="keyword">id</span> *)arg4;</div><div class="line">+ (<span class="keyword">void</span>)GetPathOfAppImgCacheDir:(<span class="keyword">id</span>)arg1 retStrPath:(<span class="keyword">id</span> *)arg2;</div><div class="line">+ (<span class="keyword">void</span>)GetPathOfAppDir:(<span class="keyword">id</span>)arg1 retStrPath:(<span class="keyword">id</span> *)arg2;</div><div class="line">+ (<span class="keyword">id</span>)getMessageListStatusImage:(<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg1;</div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsDisplayName; <span class="comment">// @synthesize m_nsDisplayName;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> m_sequenceId; <span class="comment">// @synthesize m_sequenceId;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> m_isEnterpriseMsg; <span class="comment">// @synthesize m_isEnterpriseMsg;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> m_isTempSessionMsg; <span class="comment">// @synthesize m_isTempSessionMsg;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">int</span> watchMsgSourceType; <span class="comment">// @synthesize watchMsgSourceType;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsAtUserList; <span class="comment">// @synthesize m_nsAtUserList;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiBizChatVer; <span class="comment">// @synthesize m_uiBizChatVer;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsBizChatId; <span class="comment">// @synthesize m_nsBizChatId;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsBizClientMsgID; <span class="comment">// @synthesize m_nsBizClientMsgID;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsKFWorkerOpenID; <span class="comment">// @synthesize m_nsKFWorkerOpenID;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiDownloadStatus; <span class="comment">// @synthesize m_uiDownloadStatus;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiPercent; <span class="comment">// @synthesize m_uiPercent;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsPattern; <span class="comment">// @synthesize m_nsPattern;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiEmojiStatFlag; <span class="comment">// @synthesize m_uiEmojiStatFlag;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiSendTime; <span class="comment">// @synthesize m_uiSendTime;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> m_bNew; <span class="comment">// @synthesize m_bNew;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> m_bIsSplit; <span class="comment">// @synthesize m_bIsSplit;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSData</span> *m_dtThumbnail; <span class="comment">// @synthesize m_dtThumbnail;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> m_bCdnForward; <span class="comment">// @synthesize m_bCdnForward;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> m_bForward; <span class="comment">// @synthesize m_bForward;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsRealChatUsr; <span class="comment">// @synthesize m_nsRealChatUsr;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="keyword">id</span> &lt;IMsgExtendOperation&gt; m_extendInfoWithFromUsr; <span class="comment">// @synthesize m_extendInfoWithFromUsr;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="keyword">id</span> &lt;IMsgExtendOperation&gt; m_extendInfoWithMsgType; <span class="comment">// @synthesize m_extendInfoWithMsgType;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="keyword">id</span> &lt;IMsgExtendOperation&gt; m_extendInfoWithMsgTypeForBiz; <span class="comment">// @synthesize m_extendInfoWithMsgTypeForBiz;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsMsgSource; <span class="comment">// @synthesize m_nsMsgSource;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsPushContent; <span class="comment">// @synthesize m_nsPushContent;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiCreateTime; <span class="comment">// @synthesize m_uiCreateTime;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiMsgFlag; <span class="comment">// @synthesize m_uiMsgFlag;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiImgStatus; <span class="comment">// @synthesize m_uiImgStatus;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiStatus; <span class="comment">// @synthesize m_uiStatus;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsContent; <span class="comment">// @synthesize m_nsContent;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiMessageType; <span class="comment">// @synthesize m_uiMessageType;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsToUsr; <span class="comment">// @synthesize m_nsToUsr;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *m_nsFromUsr; <span class="comment">// @synthesize m_nsFromUsr;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">long</span> <span class="keyword">long</span> m_n64MesSvrID; <span class="comment">// @synthesize m_n64MesSvrID;</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> m_uiMesLocalID; <span class="comment">// @synthesize m_uiMesLocalID;</span></div><div class="line">- (<span class="keyword">void</span>).cxx_destruct;</div><div class="line">- (<span class="built_in">BOOL</span>)isSentOK;</div><div class="line">- (<span class="built_in">BOOL</span>)IsRoomAnnouncement;</div><div class="line">- (<span class="built_in">BOOL</span>)IsAtMe;</div><div class="line">- (<span class="built_in">BOOL</span>)isShowAppMessageBlockButton;</div><div class="line">- (<span class="built_in">BOOL</span>)isShowAppBottomButton;</div><div class="line">- (<span class="built_in">BOOL</span>)isShowCommentButton;</div><div class="line">- (<span class="keyword">id</span>)keyDescription;</div><div class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *description;</div><div class="line">- (<span class="built_in">BOOL</span>)IsNeedChatExt;</div><div class="line">- (<span class="built_in">BOOL</span>)genImageFromMMAssetAndNotify:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">id</span>)GetDisplayContent;</div><div class="line">- (<span class="keyword">id</span>)GetThumb;</div><div class="line">- (<span class="keyword">id</span>)GetImg;</div><div class="line">- (<span class="keyword">id</span>)GetMsgClientMsgID;</div><div class="line">- (<span class="built_in">BOOL</span>)IsSameMsgWithFullCheck:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="built_in">BOOL</span>)IsSameMsg:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="built_in">BOOL</span>)IsSendBySendMsg;</div><div class="line">- (<span class="built_in">BOOL</span>)IsAppMessage;</div><div class="line">- (<span class="built_in">BOOL</span>)IsShortMovieMsg;</div><div class="line">- (<span class="built_in">BOOL</span>)IsVideoMsg;</div><div class="line">- (<span class="built_in">BOOL</span>)IsImgMsg;</div><div class="line">- (<span class="built_in">BOOL</span>)IsTextMsg;</div><div class="line">- (<span class="built_in">BOOL</span>)IsChatRoomMessage;</div><div class="line">- (<span class="built_in">BOOL</span>)IsMassSendMessage;</div><div class="line">- (<span class="built_in">BOOL</span>)IsBottleMessage;</div><div class="line">- (<span class="built_in">BOOL</span>)IsQQMessage;</div><div class="line">- (<span class="built_in">BOOL</span>)IsSxMessage;</div><div class="line">- (<span class="keyword">id</span>)GetChatName;</div><div class="line">- (<span class="keyword">void</span>)AddTagToMsgSource:(<span class="keyword">id</span>)arg1 value:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)UpdateMsgSource;</div><div class="line">- (<span class="keyword">void</span>)ChangeForDisplay;</div><div class="line">- (<span class="keyword">void</span>)ChangeForBackup;</div><div class="line">- (<span class="keyword">void</span>)fillMsgSourceFromContact:(<span class="keyword">id</span>)arg1 isFromTempSession:(<span class="built_in">BOOL</span>)arg2;</div><div class="line">- (<span class="keyword">void</span>)ChangeForMsgSource;</div><div class="line">- (<span class="keyword">void</span>)ChangeForChatRoom;</div><div class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)arg1;</div><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">id</span>)methodSignatureForSelector:(SEL)arg1;</div><div class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="keyword">struct</span> _NSZone *)arg1;</div><div class="line">- (<span class="keyword">id</span>)initWithMsgType:(<span class="keyword">int</span>)arg1 nsFromUsr:(<span class="keyword">id</span>)arg2;</div><div class="line">- (<span class="keyword">id</span>)initWithMsgType:(<span class="keyword">int</span>)arg1;</div><div class="line">- (<span class="keyword">id</span>)init;</div><div class="line">- (<span class="keyword">id</span>)wishingString;</div><div class="line">- (<span class="built_in">BOOL</span>)bIsAppUrlTypeWithCanvas;</div><div class="line">- (<span class="keyword">id</span>)nativeUrl;</div><div class="line">- (<span class="keyword">int</span>)yoType;</div><div class="line">- (<span class="keyword">unsigned</span> <span class="keyword">int</span>)yoCount;</div><div class="line">- (<span class="keyword">id</span>)getNodeBtnList;</div><div class="line">- (<span class="keyword">int</span>)compareQQAscending:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">int</span>)compareSXAscending:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">int</span>)compareMessageAscending:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="keyword">int</span>)compareMessageLocalIDDescending:(<span class="keyword">id</span>)arg1;</div><div class="line">- (<span class="built_in">BOOL</span>)isAd;</div><div class="line">- (<span class="keyword">id</span>)GetCdnDownloadThumbPathOfVideo;</div><div class="line">- (<span class="keyword">id</span>)GetCdnDownloadPathOfVideo;</div></pre></td></tr></table></figure>
<p>里面有几个方法看上去很可疑：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">-<span class="ruby"> (id)GetDisplayContent;</span></div><div class="line">-<span class="ruby"> (id)GetThumb;</span></div><div class="line">-<span class="ruby"> (id)GetImg;</span></div><div class="line">-<span class="ruby"> (id)GetMsgClientMsgID;</span></div><div class="line">-<span class="ruby"> (BOOL)<span class="symbol">IsSameMsgWithFullCheck:</span>(id)arg1;</span></div><div class="line">-<span class="ruby"> (BOOL)<span class="symbol">IsSameMsg:</span>(id)arg1;</span></div><div class="line">-<span class="ruby"> (BOOL)IsSendBySendMsg;</span></div><div class="line">-<span class="ruby"> (BOOL)IsAppMessage;</span></div><div class="line">-<span class="ruby"> (BOOL)IsShortMovieMsg;</span></div><div class="line">-<span class="ruby"> (BOOL)IsVideoMsg;</span></div><div class="line">-<span class="ruby"> (BOOL)IsImgMsg;</span></div><div class="line">-<span class="ruby"> (BOOL)IsTextMsg;</span></div><div class="line">-<span class="ruby"> (BOOL)IsChatRoomMessage;</span></div><div class="line">-<span class="ruby"> (BOOL)IsMassSendMessage;</span></div><div class="line">-<span class="ruby"> (BOOL)IsBottleMessage;</span></div><div class="line">-<span class="ruby"> (BOOL)IsQQMessage;</span></div><div class="line">-<span class="ruby"> (BOOL)IsSxMessage;</span></div><div class="line">-<span class="ruby"> (id)GetChatName;</span></div></pre></td></tr></table></figure>
<p>是的，我都不想多说了，你应该可以猜到是什么意思。其中 <code>GetDisplayContent</code> 应该就是获取当前消息显示内容的方法<br>我们来验证一下：</p>
<p>为了不被其它的干扰，我重新打开了一个界面，里面只有一条聊天消息，如下：</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/wechat3_images/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%877.png?raw=true" width="320" height="568" alt="图片名称" align="center"></p>
<p>对应的<code>cell</code> 信息如下：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="variable">&lt;MultiSelectTableViewCell: 0x16395fe0; baseClass = UITableViewCell; frame = (0 41; 320 62); autoresize = W; tag = 101; layer = &lt;CALayer: 0x1632c680&gt;</span>&gt;</div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UITableViewCellContentView: 0x169804f0; frame = (0 0; 320 62); gestureRecognizers = &lt;NSArray: 0x1678a410&gt;; layer = &lt;CALayer: 0x16326d50&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;TextMessageNodeView: 0x1631f780; frame = (162 0; 149 59); layer = &lt;CALayer: 0x16760930&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIView: 0x167709e0; frame = (0 0; 101 54); layer = &lt;CALayer: 0x16167ca0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x16737390; frame = (0 0; 101 54); clipsToBounds = YES; opaque = NO; layer = &lt;CALayer: 0x16713760&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;RichTextView: 0x167d9840; baseClass = UILabel; frame = (18 14; 64 20); opaque = NO; layer = &lt;_UILabelLayer: 0x14fa2540&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;_UILabelContentLayer: 0x14f58480&gt; (layer)</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIView: 0x16783120; frame = (104 1; 47 47); gestureRecognizers = &lt;NSArray: 0x16671f40&gt;; layer = &lt;CALayer: 0x163184c0&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIButton: 0x14f95670; frame = (3 1; 40 40); opaque = NO; tag = 100001; layer = &lt;CALayer: 0x16345890&gt;&gt;</span></div><div class="line">   |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string"> &lt;UIImageView: 0x16361240; frame = (0 0; 40 40); clipsToBounds = YES; opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x1674c0c0&gt;&gt;</span></div></pre></td></tr></table></figure>
<p>我们来尝试着获取<code>TextMessageNodeView</code>中的<code>m_oMessageWrap</code>的值：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">cy<span class="meta"># var myMsg = [#0x1631f780 valueForKey:@<span class="string">"m_oMessageWrap"</span>]</span></div><div class="line"><span class="meta">#<span class="string">"&#123;m_uiMesLocalID=1, m_ui64MesSvrID=4285525108122338937, m_nsFromUsr=wxi*j22~19, m_nsToUsr=wxi*w21~19, m_uiStatus=2, type=1, msgSource=\"</span>(null)\<span class="string">"&#125; "</span></span></div><div class="line">cy<span class="meta"># [myMsg GetDisplayContent]</span></div><div class="line">@<span class="string">"i like you"</span></div></pre></td></tr></table></figure>
<p>是的，就是它了，<code>cell</code> 绑定的<code>model</code>就是<code>CMessageWrap</code> , <code>CMessageWrap</code>中的<code>GetDisplayContent</code>返回一个值给<code>cell</code> 的 <code>TextMessageNodeView</code>去显示，以就是说，我们只需要hook <code>CMessageWrap</code>的<code>GetDisplayContent</code>方法，让其对指定的联系人返回一段密文就可以啦</p>
<p><strong>下一篇：（非越狱版）iOS微信聊天加密插件 （四）终结篇</strong></p>
<p><strong>郑重声明：未经本人允许严禁任何个人或组织转载！</strong></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/09/06/wechat-secret-3/" data-id="cit06qt3d0006afag3tnvaswd" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2016/09/06/wechat-secret-4/" class="pre">（非越狱版）iOS微信聊天加密插件 （四）终结篇</a><a href="/2016/09/06/wechat-secret-2/" class="next">（非越狱版）iOS微信聊天加密插件 （二）</a></div><div data-thread-key="2016/09/06/wechat-secret-3/" data-title="（非越狱版）iOS微信聊天加密插件 （三）" data-url="http://yoursite.com/2016/09/06/wechat-secret-3/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/09/06/wechat-secret-3/" data-title="（非越狱版）iOS微信聊天加密插件 （三）" data-url="http://yoursite.com/2016/09/06/wechat-secret-3/" data-author-key="1" class="ds-thread"></div><div id="disqus_thread"><script>var disqus_shortname = 'wmf00032-github-io';
var disqus_identifier = '2016/09/06/wechat-secret-3/';
var disqus_title = '（非越狱版）iOS微信聊天加密插件 （三）';
var disqus_url = 'http://yoursite.com/2016/09/06/wechat-secret-3/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wmf00032-github-io.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://yoursite.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/09/12/dylib1/">dylib1</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/06/wechat-secret-4/">（非越狱版）iOS微信聊天加密插件 （四）终结篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/06/wechat-secret-3/">（非越狱版）iOS微信聊天加密插件 （三）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/06/wechat-secret-2/">（非越狱版）iOS微信聊天加密插件 （二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/06/wechat-secret/">（非越狱版）iOS微信聊天加密插件 （一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/12/afnetworking-know-what/">AFNetWorking 深度理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/09/my-new-wmf/">iOS 基于AVPLayer封装视频播放器</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//wmf00032-github-io.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">王孟发.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'wmf00032'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>