<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="iOS高级工程师"><title>iOS 运行时类的加载深入解析 | 王孟发</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">iOS 运行时类的加载深入解析</h1><a id="logo" href="/.">王孟发</a><p class="description">跟着梦想去飞翔~   https://github.com/wmf00032</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about.html"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">iOS 运行时类的加载深入解析</h1><div class="post-meta">Sep 12, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/09/12/runtimeClassLoad/" href="/2016/09/12/runtimeClassLoad/#comments" class="ds-thread-count"></a><a data-disqus-identifier="2016/09/12/runtimeClassLoad/" href="/2016/09/12/runtimeClassLoad/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#分类的加载和调用"><span class="toc-number">1.</span> <span class="toc-text">分类的加载和调用</span></a></li></ol></div></div><div class="post-content"><p>直奔主题，当我们运行<code>OC</code>程序的时候，类以及类的方法和属性是怎么样被加载进内存的，当我们调用对象的方法时候，有事如何找到方法并执行的。</p>
<p>我们写一段最简单的测试代码，如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">TestObject </span>: NSObject</div><div class="line">- (void)runTest;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> TestObject</div><div class="line"></div><div class="line">+ (void)load&#123;</div><div class="line">    NSLog(@"------Hello  load");</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)runTest&#123;</div><div class="line">    NSLog(@"Hello, World!");</div><div class="line">&#125;</div><div class="line"><span class="variable">@end</span></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    <span class="variable">@autoreleasepool</span> &#123;</div><div class="line">        <span class="comment">// insert code here...</span></div><div class="line"></div><div class="line">        TestObject *myObject = <span class="selector-attr">[[TestObject alloc]</span> <span class="selector-tag">init</span>];</div><div class="line">        <span class="selector-attr">[myObject runTest]</span>;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    return <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们在<code>+load</code>方法上打个断点：</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/runtime1/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%87.png?raw=true" alt=""></p>
<p>运行程序后我们看见的调用栈是这样的：</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/runtime1/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%872.png?raw=true" alt=""></p>
<p>程序运行时 <code>dyldStartup</code> 的 <code>_dyld_start</code>，<code>dyld</code>启动成功后就会通过<code>dyld::notifySingle:</code>消息通知调用<code>load_images</code>方法，顾名思义，<code>load_images</code>就是用来加载各种库文件的用的，我们在里面打一个断点看一下输出：</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/runtime1/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%873.png?raw=true" alt=""></p>
<p>运行后输出如下：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$0</span> = 0x00007fff8a11b4d0 <span class="string">"/usr/lib/libSystem.B.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$1</span> = 0x00000001000055c0 <span class="string">"/Applications/Xcode.app/Contents/Developer/usr/lib/libBacktraceRecording.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$2</span> = 0x00007fff9c073610 <span class="string">"/usr/lib/libc++abi.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$3</span> = 0x00007fff95e03610 <span class="string">"/usr/lib/libc++.1.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$4</span> = 0x00007fff8dbe6520 <span class="string">"/usr/lib/libDiagnosticMessagesClient.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$5</span> = 0x00007fff8ec1b610 <span class="string">"/usr/lib/libauto.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$6</span> = 0x00007fff5fc40d08 <span class="string">"/Users/wangmengfa/Library/Developer/Xcode/DerivedData/objc-dfcsadmeyghvfwbfqqqomyuussfn/Build/Products/Debug/libobjc.A.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$7</span> = 0x00007fff9807c570 <span class="string">"/usr/lib/libicucore.A.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$8</span> = 0x00007fff8f7ce480 <span class="string">"/usr/lib/libz.1.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$9</span> = 0x00007fff951bdec8 <span class="string">"/System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$10</span> = 0x00000001005d84d0 <span class="string">"/System/Library/CoreServices/Encodings/libSimplifiedChineseConverter.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$11</span> = 0x00007fff8de59ac0 <span class="string">"/usr/lib/libextension.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$12</span> = 0x00007fff9b588390 <span class="string">"/usr/lib/libenergytrace.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$13</span> = 0x00007fff98f26520 <span class="string">"/usr/lib/libbsm.0.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$14</span> = 0x00007fff9d2ac4d0 <span class="string">"/usr/lib/system/libkxld.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$15</span> = 0x00007fff8d9a45c0 <span class="string">"/System/Library/Frameworks/IOKit.framework/Versions/A/IOKit"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$16</span> = 0x00007fff8cc80480 <span class="string">"/usr/lib/libbz2.1.0.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$17</span> = 0x00007fff8b2a5520 <span class="string">"/usr/lib/libxml2.2.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$18</span> = 0x00007fff94b134d0 <span class="string">"/usr/lib/libxar.1.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$19</span> = 0x00007fff8a11d570 <span class="string">"/usr/lib/libsqlite3.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$20</span> = 0x00007fff9828a570 <span class="string">"/usr/lib/libpam.2.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$21</span> = 0x00007fff8f37c390 <span class="string">"/usr/lib/libOpenScriptingUtil.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$22</span> = 0x00007fff8ac487a0 <span class="string">"/System/Library/Frameworks/Security.framework/Versions/A/Security"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$23</span> = 0x00007fff8dc0a570 <span class="string">"/System/Library/Frameworks/DiskArbitration.framework/Versions/A/DiskArbitration"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$24</span> = 0x00007fff87234430 <span class="string">"/usr/lib/liblzma.5.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$25</span> = 0x00007fff91170480 <span class="string">"/usr/lib/libarchive.2.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$26</span> = 0x00007fff91c2b610 <span class="string">"/System/Library/Frameworks/SystemConfiguration.framework/Versions/A/SystemConfiguration"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$27</span> = 0x00007fff98c95c00 <span class="string">"/System/Library/Frameworks/CFNetwork.framework/Versions/A/CFNetwork"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$28</span> = 0x00007fff94942520 <span class="string">"/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/FSEvents.framework/Versions/A/FSEvents"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$29</span> = 0x00007fff9a27d570 <span class="string">"/System/Library/PrivateFrameworks/login.framework/Versions/A/Frameworks/loginsupport.framework/Versions/A/loginsupport"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$30</span> = 0x00007fff8f688520 <span class="string">"/System/Library/PrivateFrameworks/NetAuth.framework/Versions/A/NetAuth"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$31</span> = 0x00007fff9c98f520 <span class="string">"/System/Library/Frameworks/NetFS.framework/Versions/A/NetFS"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$32</span> = 0x00007fff8f37d610 <span class="string">"/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/CarbonCore"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$33</span> = 0x00007fff8f215520 <span class="string">"/usr/lib/libiconv.2.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$34</span> = 0x00007fff8d7bb480 <span class="string">"/usr/lib/libcmph.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$35</span> = 0x00007fff873b5660 <span class="string">"/System/Library/PrivateFrameworks/LanguageModeling.framework/Versions/A/LanguageModeling"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$36</span> = 0x00007fff938bf4d0 <span class="string">"/usr/lib/libmarisa.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$37</span> = 0x00007fff88ca0570 <span class="string">"/usr/lib/libCRFSuite.dylib"</span></div><div class="line">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span>) <span class="variable">$38</span> = 0x00007fff94b715c0 <span class="string">"/usr/lib/libChineseTokenizer.dylib"</span></div></pre></td></tr></table></figure>
<p>各种应用库文件的路径，这些库就是在这个被加载的。</p>
<p>接下来，<code>load_images_nolock</code> 方法用来加载具有<code>+load</code>方法的镜像。它的实现是这样的：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">bool </div><div class="line">load_images_nolock(<span class="class"><span class="keyword">enum</span> <span class="title">dyld_image_states</span> <span class="title">state</span>,<span class="title">uint32_t</span> <span class="title">infoCount</span>,</span></div><div class="line">                   const <span class="class"><span class="keyword">struct</span> <span class="title">dyld_image_info</span> <span class="title">infoList</span>[])</span></div><div class="line">&#123;</div><div class="line">    bool found = NO;</div><div class="line">    uint32_t i;</div><div class="line"></div><div class="line">    i = infoCount;</div><div class="line">    <span class="keyword">while</span> (i--) &#123;</div><div class="line">        const headerType *mhdr = (headerType*)infoList[i].imageLoadAddress;</div><div class="line">        <span class="keyword">if</span> (!hasLoadMethods(mhdr)) continue;</div><div class="line"></div><div class="line">        prepare_load_methods(mhdr);</div><div class="line">        found = YES;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> found;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果 <code>imageLoadAddress</code> 中有<code>+load</code>方法，就会执行 <code>prepare_load_methods(mhdr);</code> 并将<code>found = YES</code> 返回。<code>prepare_load_methods</code>中的实现是这样的：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">void prepare_load_methods(const headerType *mhdr)</div><div class="line">&#123;</div><div class="line">    size_t <span class="built_in">count</span>, i<span class="comment">;</span></div><div class="line"></div><div class="line">    runtimeLock.assertWriting()<span class="comment">;</span></div><div class="line"></div><div class="line">    classref_t *classlist = </div><div class="line">        _getObjc2NonlazyClassList(mhdr, &amp;<span class="built_in">count</span>)<span class="comment">;</span></div><div class="line">    for (i = <span class="number">0</span><span class="comment">; i &lt; count; i++) &#123;</span></div><div class="line">        <span class="keyword">schedule_class_load(remapClass(classlist[i]));</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    category_t **categorylist = _getObjc2NonlazyCategoryList(mhdr, &amp;<span class="built_in">count</span>)<span class="comment">;</span></div><div class="line">    for (i = <span class="number">0</span><span class="comment">; i &lt; count; i++) &#123;</span></div><div class="line">        category_t *cat = categorylist[i]<span class="comment">;</span></div><div class="line">        Class cls = remapClass(cat-&gt;cls)<span class="comment">;</span></div><div class="line">        if (!cls) continue<span class="comment">;  // category for ignored weak-linked class</span></div><div class="line">        realizeClass(cls)<span class="comment">;</span></div><div class="line">        assert(cls-&gt;ISA()-&gt;isRealized())<span class="comment">;</span></div><div class="line">        <span class="keyword">add_category_to_loadable_list(cat);</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>里面有个方法<code>schedule_class_load</code> 用来预加载具有<code>+load</code>方法的类 和方法实现。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> void schedule_class_load(<span class="class"><span class="keyword">Class</span> <span class="title">cls</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span>;</div><div class="line">    assert(cls-&gt;isRealized());  <span class="comment">// _read_images should realize</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (cls-&gt;data()-&gt;flags &amp; RW_LOADED) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Ensure superclass-first ordering</span></div><div class="line">    schedule_class_load(cls-&gt;superclass);</div><div class="line"></div><div class="line">    add_class_to_loadable_list(cls);</div><div class="line">    cls-&gt;setInfo(RW_LOADED); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中<code>schedule_class_load(cls-&gt;superclass);</code>用来加载父类中的<code>+load</code>，<code>add_class_to_loadable_list</code>就是用来将具有<code>+load</code>方法的类信息和实现添加到<code>loadable_classes</code>集合之中。它的实现如下：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">void add_class_to_loadable_list(Class <span class="keyword">cls</span>)</div><div class="line">&#123;</div><div class="line">    IMP method;</div><div class="line"></div><div class="line">    loadMethodLock.assertLocked();</div><div class="line"></div><div class="line">    method = <span class="keyword">cls</span>-&gt;getLoadMethod();</div><div class="line">    <span class="keyword">if</span> (!method) <span class="keyword">return</span>;  <span class="comment">// Don't bother if cls has no +load method</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (PrintLoading) &#123;</div><div class="line">        _objc_inform(<span class="string">"LOAD: class '%s' scheduled for +load"</span>, </div><div class="line">                     <span class="keyword">cls</span>-&gt;nameForLogging());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (loadable_classes_used == loadable_classes_allocated) &#123;</div><div class="line">        loadable_classes_allocated = loadable_classes_allocated*<span class="number">2</span> + <span class="number">16</span>;</div><div class="line">        loadable_classes = (<span class="keyword">struct</span> loadable_class *)</div><div class="line">            realloc(loadable_classes,</div><div class="line">                              loadable_classes_allocated *</div><div class="line">                              sizeof(<span class="keyword">struct</span> loadable_class));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    loadable_classes[loadable_classes_used].<span class="keyword">cls</span> = <span class="keyword">cls</span>;</div><div class="line">    loadable_classes[loadable_classes_used].method = method;</div><div class="line">    loadable_classes_used++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>回到<code>prepare_load_methods</code>方法中，<code>add_category_to_loadable_list</code>就是讲<code>+load</code>方法的分类加载到<code>loadable_categories</code>集合之中。</p>
<p>回到<code>load_images</code> 方法，如果当前的<code>+load</code>方法加载成功了，下面就是调用 <code>call_load_methods()</code>调用<code>+load</code>方法啦。它的实现如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> call_load_methods(<span class="keyword">void</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> loading = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">bool</span> more_categories;</div><div class="line"></div><div class="line">    loadMethodLock.assertLocked();</div><div class="line"></div><div class="line">    <span class="comment">// Re-entrant calls do nothing; the outermost call will finish the job.</span></div><div class="line">    <span class="keyword">if</span> (loading) <span class="keyword">return</span>;</div><div class="line">    loading = <span class="literal">YES</span>;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> *pool = objc_autoreleasePoolPush();</div><div class="line"></div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="comment">// 1. Repeatedly call class +loads until there aren't any more</span></div><div class="line">        <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>) &#123;</div><div class="line">            call_class_loads();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 2. Call category +loads ONCE</span></div><div class="line">        more_categories = call_category_loads();</div><div class="line"></div><div class="line">        <span class="comment">// 3. Run more +loads if there are classes OR more untried categories</span></div><div class="line">    &#125; <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>  ||  more_categories);</div><div class="line"></div><div class="line">    objc_autoreleasePoolPop(pool);</div><div class="line"></div><div class="line">    loading = <span class="literal">NO</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法分为3部分：</p>
<blockquote>
<pre><code>1. 循环调用 `loadable_classes` 队列中 `+load`方法，确保没有更多的 `+load` 方法被遗忘。
2. 分类中的 `+load` 方法被调用一次
3. 调用其它可能存在的类和分类的 `+load` 方法
</code></pre></blockquote>
<p>我们可以看一下 <code>call_class_loads()</code>方法的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">call_class_loads</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    </div><div class="line">    <span class="comment">// Detach current loadable list.</span></div><div class="line">    <span class="keyword">struct</span> loadable_class *classes = loadable_classes;</div><div class="line">    <span class="keyword">int</span> used = loadable_classes_used;</div><div class="line">    loadable_classes = nil;</div><div class="line">    loadable_classes_allocated = <span class="number">0</span>;</div><div class="line">    loadable_classes_used = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// Call all +loads for the detached list.</span></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; used; i++) &#123;</div><div class="line">        Class cls = classes[i].cls;</div><div class="line">        <span class="keyword">load_method_t</span> load_method = (<span class="keyword">load_method_t</span>)classes[i].method;</div><div class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>; </div><div class="line"></div><div class="line">        <span class="keyword">if</span> (PrintLoading) &#123;</div><div class="line">            <span class="number">_</span>objc_inform(<span class="string">"LOAD: +[%s load]\n"</span>, cls-&gt;nameForLogging());</div><div class="line">        &#125;</div><div class="line">        (*load_method)(cls, SEL_load);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// Destroy the detached list.</span></div><div class="line">    <span class="keyword">if</span> (classes) <span class="built_in">free</span>(classes);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>loadable_classes</code> 就只之前我们讲的保存<code>+load</code>方法的队列，被赋值给 <code>classes</code> 指针，注意了变量<code>loadable_classes_used = 0；</code><br>被赋值为<code>0</code>啦。但<code>used</code> 中去保存在它之前的值。<br><code>load_method_t load_method = (load_method_t)classes[i].method;</code> 获取到了 <code>+load</code>方法的实现指针，通过<code>(*load_method)(cls, SEL_load);</code> 就被调用啦， <code>call_category_loads()；</code>方法的实现同理就不再赘述！ 支持 <code>+load</code>方法的加载和调用就结束啦。</p>
<h1 id="分类的加载和调用"><a href="#分类的加载和调用" class="headerlink" title="分类的加载和调用"></a>分类的加载和调用</h1><p>当动态库加载完成之后，加载 类的时候就会调用 _objc_init方法，它的实现如下：</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">void</span> _objc_init(<span class="built_in">void</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">bool</span> initialized = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">if</span> (initialized) <span class="keyword">return</span>;</div><div class="line">    initialized = <span class="literal">true</span>;</div><div class="line"></div><div class="line">    // fixme defer initialization until an objc-<span class="keyword">using</span> image <span class="keyword">is</span> found?</div><div class="line">    environ_init();</div><div class="line">    tls_init();</div><div class="line">    static_init();</div><div class="line">    lock_init();</div><div class="line">    exception_init();</div><div class="line">    </div><div class="line">    // <span class="type">Register</span> <span class="keyword">for</span> unmap first, <span class="keyword">in</span> <span class="keyword">case</span> some +load unmaps something</div><div class="line">    _dyld_register_func_for_remove_image(&amp;unmap_image);</div><div class="line">    dyld_register_image_state_change_handler(dyld_image_state_bound,</div><div class="line">                                             <span class="number">1</span>/*batch*/, &amp;map_2_images);</div><div class="line">    dyld_register_image_state_change_handler(dyld_image_state_dependents_initialized, <span class="number">0</span>/*<span class="keyword">not</span> batch*/, &amp;load_images);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中代码：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dyld_register_image_state_change_handler(<span class="name">dyld_image_state_dependents_initialized</span>, <span class="number">0</span>/*not batch*/, <span class="symbol">&amp;load_images</span>)<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>中的 <code>load_images</code> 就是上一节中我们探讨的<code>+load</code>的加载和调用过程。</p>
<p>我们现在要探讨 </p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">    dyld_register_image_state_change_handler(<span class="name">dyld_image_state_bound</span>,</div><div class="line">                                             <span class="number">1</span>/*batch*/, <span class="symbol">&amp;map_2_images</span>)<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>的 <code>map_2_images</code>方法都做了什么。</p>
<p>我们进入 <code>map_2_images</code> 方法中的  <code>map_images_nolock</code> 方法，在这个方法的最底部一个句代码<code>_read_images(hList, hCount);</code> 进去看一下这个方法的实现，这个方法有点长，我们主要展示和分析一下里面的核心代码。</p>
<p>其中代码片段：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">// Discover protocols. Fix up protocol refs.</span></div><div class="line">    <span class="keyword">for</span> (EACH_HEADER) &#123;</div><div class="line">        extern objc_class OBJC_CLASS_<span class="variable">$_Protocol</span>;</div><div class="line">        <span class="keyword">Class</span> cls = (<span class="keyword">Class</span>)&amp;OBJC_CLASS_<span class="variable">$_Protocol</span>;</div><div class="line">        <span class="keyword">assert</span>(cls);</div><div class="line">        NXMapTable *protocol_map = protocols();</div><div class="line">        bool isPreoptimized = hi-&gt;isPreoptimized();</div><div class="line">        bool isBundle = hi-&gt;isBundle();</div><div class="line"></div><div class="line">        protocol_t **protolist = _getObjc2ProtocolList(hi, &amp;<span class="keyword">count</span>);</div><div class="line">        <span class="keyword">for</span> (i = 0; i &lt; <span class="keyword">count</span>; i++) &#123;</div><div class="line">            readProtocol(protolist[i], cls, protocol_map, </div><div class="line">                         isPreoptimized, isBundle);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>很明显是用来加载 类中的协议的。代码片段：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">    // Realize non-<span class="built_in">lazy</span> classes (<span class="keyword">for</span> +load methods and static instances)</div><div class="line">    <span class="keyword">for</span> (EACH_HEADER) &#123;</div><div class="line">        classref_t *classlist = </div><div class="line">            _getObjc2NonlazyClassList(hi, &amp;count);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            <span class="keyword">Class</span> cls = remapClass(classlist[i]);</div><div class="line">            <span class="keyword">if</span> (!cls) continue;</div><div class="line"></div><div class="line">            // hack <span class="keyword">for</span> class __ARCLite__, which didn't get this above</div><div class="line">#<span class="keyword">if</span> TARGET_IPHONE_SIMULATOR</div><div class="line">            <span class="keyword">if</span> (cls-&gt;cache._buckets == (void*)&amp;_objc_empty_cache  &amp;&amp;  </div><div class="line">                (cls-&gt;cache._mask  |<span class="type">|  cls</span>-&gt;cache._occupied)) </div><div class="line">            &#123;</div><div class="line">                cls-&gt;cache._mask = <span class="number">0</span>;</div><div class="line">                cls-&gt;cache._occupied = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (cls-&gt;ISA()-&gt;cache._buckets == (void*)&amp;_objc_empty_cache  &amp;&amp;  </div><div class="line">                (cls-&gt;ISA()-&gt;cache._mask  |<span class="type">|  cls</span>-&gt;ISA()-&gt;cache._occupied)) </div><div class="line">            &#123;</div><div class="line">                cls-&gt;ISA()-&gt;cache._mask = <span class="number">0</span>;</div><div class="line">                cls-&gt;ISA()-&gt;cache._occupied = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">            realizeClass(cls);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>那么这段代码片段是比较重要的，主要用来实现某个类的，我们拿它做重点分析。首先看一下 <code>realizeClass(cls)；</code>中的实现：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line">static Class realizeClass(Class cls)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertWriting();</div><div class="line"></div><div class="line">    const class_ro_t *ro;</div><div class="line">    class_rw_t *rw;</div><div class="line">    Class supercls;</div><div class="line">    Class metacls;</div><div class="line">    bool isMeta;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!cls) return <span class="literal">nil</span>;</div><div class="line">    <span class="function"><span class="title">if</span> (cls-&gt;</span>isRealized()) return cls;</div><div class="line">    assert(cls == remapClass(cls));</div><div class="line"></div><div class="line">    <span class="comment">// fixme verify class is not in an un-dlopened part of the shared cache?</span></div><div class="line"></div><div class="line">    <span class="function"><span class="title">ro</span> = (const class_ro_t *)cls-&gt;</span><span class="keyword">data</span>();</div><div class="line">    <span class="function"><span class="title">if</span> (ro-&gt;</span>flags &amp; RO_FUTURE) &#123;</div><div class="line">        <span class="comment">// This was a future class. rw data is already allocated.</span></div><div class="line">        <span class="function"><span class="title">rw</span> = cls-&gt;</span><span class="keyword">data</span>();</div><div class="line">        <span class="function"><span class="title">ro</span> = cls-&gt;</span><span class="function"><span class="title">data</span>()-&gt;</span>ro;</div><div class="line">        <span class="function"><span class="title">cls</span>-&gt;</span>changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Normal class. Allocate writeable class data.</span></div><div class="line">        rw = (class_rw_t *)calloc(sizeof(class_rw_t), <span class="number">1</span>);</div><div class="line">        <span class="function"><span class="title">rw</span>-&gt;</span>ro = ro;</div><div class="line">        <span class="function"><span class="title">rw</span>-&gt;</span>flags = RW_REALIZED|RW_REALIZING;</div><div class="line">        <span class="function"><span class="title">cls</span>-&gt;</span>setData(rw);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="title">isMeta</span> = ro-&gt;</span>flags &amp; RO_META;</div><div class="line"></div><div class="line">    <span class="function"><span class="title">rw</span>-&gt;</span>version = isMeta ? <span class="number">7</span> : <span class="number">0</span>;  <span class="comment">// old runtime went up to 6</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (PrintConnecting) &#123;</div><div class="line">        _objc_inform(<span class="string">"CLASS: realizing class '%s' %s %p %p"</span>, </div><div class="line">                     <span class="function"><span class="title">cls</span>-&gt;</span>nameForLogging(), isMeta ? <span class="string">"(meta)"</span> : <span class="string">""</span>, </div><div class="line">                     (void*)cls, ro);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Realize superclass and metaclass, if they aren't already.</span></div><div class="line">    <span class="comment">// This needs to be done after RW_REALIZED is set above, for root classes.</span></div><div class="line">    <span class="function"><span class="title">supercls</span> = realizeClass(remapClass(cls-&gt;</span>superclass));</div><div class="line">    <span class="function"><span class="title">metacls</span> = realizeClass(remapClass(cls-&gt;</span>ISA()));</div><div class="line"></div><div class="line">    <span class="comment">// Update superclass and metaclass in case of remapping</span></div><div class="line">    <span class="function"><span class="title">cls</span>-&gt;</span>superclass = supercls;</div><div class="line">    <span class="function"><span class="title">cls</span>-&gt;</span>initClassIsa(metacls);</div><div class="line"></div><div class="line">    <span class="comment">// Reconcile instance variable offsets / layout.</span></div><div class="line">    <span class="comment">// This may reallocate class_ro_t, updating our ro variable.</span></div><div class="line">    <span class="keyword">if</span> (supercls  &amp;&amp;  !isMeta) reconcileInstanceVariables(cls, supercls, ro);</div><div class="line"></div><div class="line">    <span class="comment">// Set fastInstanceSize if it wasn't set already.</span></div><div class="line">    <span class="function"><span class="title">cls</span>-&gt;</span><span class="function"><span class="title">setInstanceSize</span>(ro-&gt;</span>instanceSize);</div><div class="line"></div><div class="line">    <span class="comment">// Copy some flags from ro to rw</span></div><div class="line">    <span class="function"><span class="title">if</span> (ro-&gt;</span>flags &amp; RO_HAS_CXX_STRUCTORS) &#123;</div><div class="line">        <span class="function"><span class="title">cls</span>-&gt;</span>setHasCxxDtor();</div><div class="line">        <span class="function"><span class="title">if</span> (! (ro-&gt;</span>flags &amp; RO_HAS_CXX_DTOR_ONLY)) &#123;</div><div class="line">            <span class="function"><span class="title">cls</span>-&gt;</span>setHasCxxCtor();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Disable non-pointer isa for some classes and/or platforms.</span></div><div class="line">#<span class="keyword">if</span> SUPPORT_NONPOINTER_ISA</div><div class="line">    &#123;</div><div class="line">        bool disable = <span class="literal">false</span>;</div><div class="line">        static bool hackedDispatch = <span class="literal">false</span>;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (DisableIndexedIsa) &#123;</div><div class="line">            <span class="comment">// Non-pointer isa disabled by environment or GC or app SDK version</span></div><div class="line">            disable = <span class="literal">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="title">else</span> <span class="keyword">if</span> (!hackedDispatch  &amp;&amp;  !(ro-&gt;</span>flags &amp; RO_META)  &amp;&amp;  </div><div class="line">                 <span class="number">0</span> == <span class="function"><span class="title">strcmp</span>(ro-&gt;</span><span class="keyword">name</span>, <span class="string">"OS_object"</span>)) </div><div class="line">        &#123;</div><div class="line">            <span class="comment">// hack for libdispatch et al - isa also acts as vtable pointer</span></div><div class="line">            hackedDispatch = <span class="literal">true</span>;</div><div class="line">            disable = <span class="literal">true</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (disable) &#123;</div><div class="line">            <span class="function"><span class="title">cls</span>-&gt;</span>setRequiresRawIsa(<span class="literal">false</span><span class="comment">/*inherited*/</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">    <span class="comment">// Connect this class to its superclass's subclass lists</span></div><div class="line">    <span class="keyword">if</span> (supercls) &#123;</div><div class="line">        addSubclass(supercls, cls);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Attach categories</span></div><div class="line">    methodizeClass(cls);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!isMeta) &#123;</div><div class="line">        addRealizedClass(cls);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        addRealizedMetaclass(cls);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return cls;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们在其中加一个断点如下：</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/runtime1/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%874.png?raw=true" alt=""></p>
<p>打印结果部分如下：</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/runtime1/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%875.png?raw=true" alt=""></p>
<p>类中的方法 以及方法类型和实现 都被赋值上了对应的数据。</p>
<p>我们再看一下 <code>realizeClass</code> 方法中的代码 <code>methodizeClass(cls);</code>里面的实现是这样的：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">static void methodizeClass(Class cls)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertWriting();</div><div class="line"></div><div class="line">    <span class="function"><span class="title">bool</span> isMeta = cls-&gt;</span>isMetaClass();</div><div class="line">    <span class="function"><span class="title">auto</span> rw = cls-&gt;</span><span class="keyword">data</span>();</div><div class="line">    <span class="function"><span class="title">auto</span> ro = rw-&gt;</span>ro;</div><div class="line"></div><div class="line">    <span class="comment">// Methodizing for the first time</span></div><div class="line">    <span class="keyword">if</span> (PrintConnecting) &#123;</div><div class="line">        _objc_inform(<span class="string">"CLASS: methodizing class '%s' %s"</span>, </div><div class="line">                     <span class="function"><span class="title">cls</span>-&gt;</span>nameForLogging(), isMeta ? <span class="string">"(meta)"</span> : <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Install methods and properties that the class implements itself.</span></div><div class="line">    <span class="function"><span class="title">method_list_t</span> *list = ro-&gt;</span>baseMethods();</div><div class="line">    <span class="keyword">if</span> (list) &#123;</div><div class="line">        prepareMethodLists(cls, &amp;list, <span class="number">1</span>, YES, isBundleClass(cls));</div><div class="line">        <span class="function"><span class="title">rw</span>-&gt;</span>methods.attachLists(&amp;list, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="title">property_list_t</span> *proplist = ro-&gt;</span>baseProperties;</div><div class="line">    <span class="keyword">if</span> (proplist) &#123;</div><div class="line">        <span class="function"><span class="title">rw</span>-&gt;</span>properties.attachLists(&amp;proplist, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="title">protocol_list_t</span> *protolist = ro-&gt;</span>baseProtocols;</div><div class="line">    <span class="keyword">if</span> (protolist) &#123;</div><div class="line">        <span class="function"><span class="title">rw</span>-&gt;</span>protocols.attachLists(&amp;protolist, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Root classes get bonus method implementations if they don't have </span></div><div class="line">    <span class="comment">// them already. These apply before category replacements.</span></div><div class="line">    <span class="function"><span class="title">if</span> (cls-&gt;</span>isRootMetaclass()) &#123;</div><div class="line">        <span class="comment">// root metaclass</span></div><div class="line">        addMethod(cls, SEL_initialize, (IMP)&amp;objc_noop_imp, <span class="string">""</span>, NO);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Attach categories.</span></div><div class="line">    category_list *cats = unattachedCategoriesForClass(cls, <span class="literal">true</span> <span class="comment">/*realizing*/</span>);</div><div class="line">    attachCategories(cls, cats, <span class="literal">false</span> <span class="comment">/*don't flush caches*/</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (PrintConnecting) &#123;</div><div class="line">        <span class="keyword">if</span> (cats) &#123;</div><div class="line">            <span class="function"><span class="title">for</span> (uint32_t i = 0; i &lt; cats-&gt;</span>count; i++) &#123;</div><div class="line">                _objc_inform(<span class="string">"CLASS: attached category %c%s(%s)"</span>, </div><div class="line">                             isMeta ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                             <span class="function"><span class="title">cls</span>-&gt;</span><span class="function"><span class="title">nameForLogging</span>(), cats-&gt;</span><span class="function"><span class="title">list</span>[i].cat-&gt;</span><span class="keyword">name</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (cats) free(cats);</div><div class="line"></div><div class="line">#<span class="keyword">if</span> DEBUG</div><div class="line">    <span class="comment">// De<span class="doctag">bug:</span> sanity-check all SELs; log method list contents</span></div><div class="line">    <span class="function"><span class="title">for</span> (const auto&amp; meth : rw-&gt;</span>methods) &#123;</div><div class="line">        <span class="keyword">if</span> (PrintConnecting) &#123;</div><div class="line">            _objc_inform(<span class="string">"METHOD %c[%s %s]"</span>, isMeta ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                         <span class="function"><span class="title">cls</span>-&gt;</span>nameForLogging(), sel_getName(meth.<span class="keyword">name</span>));</div><div class="line">        &#125;</div><div class="line">        assert(ignoreSelector(meth.<span class="keyword">name</span>)  ||  </div><div class="line">               sel_registerName(sel_getName(meth.<span class="keyword">name</span>)) == meth.<span class="keyword">name</span>); </div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们先来分析一下<code>class</code> 结构体的结构：</p>
<p><img src="https://github.com/wmf00032/imagesRecource/blob/master/runtime1/%E6%9C%AA%E5%91%BD%E5%90%8D%E5%9B%BE%E7%89%876.png?raw=true" alt=""></p>
<p>而在 <code>methodizeClass</code> 方法中分别将 方法、属性、协议、分类添加进入各自的队列：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">    <span class="comment">// Install methods and properties that the class implements itself.</span></div><div class="line">    <span class="function"><span class="title">method_list_t</span> *list = ro-&gt;</span>baseMethods();</div><div class="line">    <span class="keyword">if</span> (list) &#123;</div><div class="line">        prepareMethodLists(cls, &amp;list, <span class="number">1</span>, YES, isBundleClass(cls));</div><div class="line">        <span class="function"><span class="title">rw</span>-&gt;</span>methods.attachLists(&amp;list, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="title">property_list_t</span> *proplist = ro-&gt;</span>baseProperties;</div><div class="line">    <span class="keyword">if</span> (proplist) &#123;</div><div class="line">        <span class="function"><span class="title">rw</span>-&gt;</span>properties.attachLists(&amp;proplist, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="title">protocol_list_t</span> *protolist = ro-&gt;</span>baseProtocols;</div><div class="line">    <span class="keyword">if</span> (protolist) &#123;</div><div class="line">        <span class="function"><span class="title">rw</span>-&gt;</span>protocols.attachLists(&amp;protolist, <span class="number">1</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这时<code>class_rw_t</code> 结构体：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">method_array_t</span> methods;</div><div class="line">    <span class="keyword">property_array_t</span> properties;</div><div class="line">    <span class="keyword">protocol_array_t</span> protocols;</div></pre></td></tr></table></figure>
<p>被赋值上对应的值。</p>
<p>我们看一下 <code>attachLists</code>方法是如何给对应类的结构体赋值数据的，方法实现如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">attachLists</span><span class="params">(List* <span class="keyword">const</span> * addedLists, <span class="keyword">uint32_t</span> addedCount)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (addedCount == <span class="number">0</span>) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (hasArray()) &#123;</div><div class="line">            <span class="comment">// many lists -&gt; many lists</span></div><div class="line">            <span class="keyword">uint32_t</span> oldCount = <span class="built_in">array</span>()-&gt;count;</div><div class="line">            <span class="keyword">uint32_t</span> newCount = oldCount + addedCount;</div><div class="line">            setArray((<span class="keyword">array_t</span> *)<span class="built_in">realloc</span>(<span class="built_in">array</span>(), <span class="keyword">array_t</span>::byteSize(newCount)));</div><div class="line">            <span class="built_in">array</span>()-&gt;count = newCount;</div><div class="line">            memmove(<span class="built_in">array</span>()-&gt;lists + addedCount, <span class="built_in">array</span>()-&gt;lists, </div><div class="line">                    oldCount * <span class="keyword">sizeof</span>(<span class="built_in">array</span>()-&gt;lists[<span class="number">0</span>]));</div><div class="line">            <span class="built_in">memcpy</span>(<span class="built_in">array</span>()-&gt;lists, addedLists, </div><div class="line">                   addedCount * <span class="keyword">sizeof</span>(<span class="built_in">array</span>()-&gt;lists[<span class="number">0</span>]));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">list</span>  &amp;&amp;  addedCount == <span class="number">1</span>) &#123;</div><div class="line">            <span class="comment">// 0 lists -&gt; 1 list</span></div><div class="line">            <span class="built_in">list</span> = addedLists[<span class="number">0</span>];</div><div class="line">        &#125; </div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 1 list -&gt; many lists</span></div><div class="line">            List* oldList = <span class="built_in">list</span>;</div><div class="line">            <span class="keyword">uint32_t</span> oldCount = oldList ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">            <span class="keyword">uint32_t</span> newCount = oldCount + addedCount;</div><div class="line">            setArray((<span class="keyword">array_t</span> *)<span class="built_in">malloc</span>(<span class="keyword">array_t</span>::byteSize(newCount)));</div><div class="line">            <span class="built_in">array</span>()-&gt;count = newCount;</div><div class="line">            <span class="keyword">if</span> (oldList) <span class="built_in">array</span>()-&gt;lists[addedCount] = oldList;</div><div class="line">            <span class="built_in">memcpy</span>(<span class="built_in">array</span>()-&gt;lists, addedLists, </div><div class="line">                   addedCount * <span class="keyword">sizeof</span>(<span class="built_in">array</span>()-&gt;lists[<span class="number">0</span>]));</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>里面有几句最关键的代码，如果 <code>hasArray()</code>返回<code>true</code>,就会执行如下代码块：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">uint32_t oldCount = array<span class="function"><span class="params">()</span>-&gt;</span>count;</div><div class="line">uint32_t newCount = oldCount + addedCount;</div><div class="line">setArray((array_t *)realloc(array(), array_t::byteSize(newCount)));</div><div class="line">array<span class="function"><span class="params">()</span>-&gt;</span>count = newCount;</div><div class="line">memmove<span class="function"><span class="params">(array()-&gt;lists + addedCount, array()-&gt;lists, </span></span></div><div class="line">        oldCount * sizeof(array()-&gt;lists[<span class="number">0</span>]));</div><div class="line"><span class="title">memcpy</span><span class="params">(array()-&gt;lists, addedLists, </span></div><div class="line">       addedCount * sizeof(array()-&gt;lists[<span class="number">0</span>]));</div></pre></td></tr></table></figure>
<p>这两句代码非常重要，有些oc性质就是这两句代码造成的。这两句代码做了如下几件事情：</p>
<blockquote>
<ol>
<li><code>setArray((array_t *)realloc(array(), array_t::byteSize(newCount)))</code> 将array内存大小修改为newCount大小。</li>
<li><p><code>array()-&gt;count = newCount;</code> 新队列的<code>size</code>变为了 <code>newCount</code></p>
</li>
<li><p><code>memmove(array()-&gt;lists + addedCount, array()-&gt;lists, oldCount * sizeof(array()-&gt;lists[0]));</code></p>
</li>
</ol>
</blockquote>
<p>将原来队列的数据移动到后面，前面空出<code>addedCount</code> 个位置。</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">memcpy<span class="function"><span class="params">(array()-&gt;lists, addedLists, </span></span></div><div class="line">                   addedCount * sizeof(array()-&gt;lists[<span class="number">0</span>]));</div></pre></td></tr></table></figure>
<p>将新数据<code>addedLists</code>插入到前面。</p>
<p>以上总结就一句话：新数据插入到了老数据前面。</p>
<p>分类方法的加载也是类似的，我们回到方法 <code>_read_images</code>中，里面有段代码块：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">for</span> (EACH_HEADER) &#123;</div><div class="line">        category_t **catlist = </div><div class="line">            _getObjc2CategoryList(hi, &amp;count);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            category_t *cat = catlist[i];</div><div class="line">            C<span class="function"><span class="title">lass</span> cls = remapClass(cat-&gt;</span>cls);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!cls) &#123;</div><div class="line">                <span class="comment">// Category's target class is missing (probably weak-linked).</span></div><div class="line">                <span class="comment">// Disavow any knowledge of this category.</span></div><div class="line">                catlist[i] = <span class="literal">nil</span>;</div><div class="line">                <span class="keyword">if</span> (PrintConnecting) &#123;</div><div class="line">                    _objc_inform(<span class="string">"CLASS: IGNORING category \?\?\?(%s) %p with "</span></div><div class="line">                                 <span class="string">"missing weak-linked target class"</span>, </div><div class="line">                                 <span class="function"><span class="title">cat</span>-&gt;</span><span class="keyword">name</span>, cat);</div><div class="line">                &#125;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Process this category. </span></div><div class="line">            <span class="comment">// First, register the category with its target class. </span></div><div class="line">            <span class="comment">// Then, rebuild the class's method lists (etc) if </span></div><div class="line">            <span class="comment">// the class is realized. </span></div><div class="line">            bool classExists = NO;</div><div class="line">            <span class="function"><span class="title">if</span> (cat-&gt;</span><span class="function"><span class="title">instanceMethods</span> ||  cat-&gt;</span>protocols  </div><div class="line">                ||  <span class="function"><span class="title">cat</span>-&gt;</span>instanceProperties) </div><div class="line">            &#123;</div><div class="line">                addUnattachedCategoryForClass(cat, cls, hi);</div><div class="line">                <span class="function"><span class="title">if</span> (cls-&gt;</span>isRealized()) &#123;</div><div class="line">                    remethodizeClass(cls);</div><div class="line">                    classExists = YES;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (PrintConnecting) &#123;</div><div class="line">                    _objc_inform(<span class="string">"CLASS: found category -%s(%s) %s"</span>, </div><div class="line">                                 <span class="function"><span class="title">cls</span>-&gt;</span><span class="function"><span class="title">nameForLogging</span>(), cat-&gt;</span><span class="keyword">name</span>, </div><div class="line">                                 classExists ? <span class="string">"on existing class"</span> : <span class="string">""</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="title">if</span> (cat-&gt;</span><span class="function"><span class="title">classMethods</span>  ||  cat-&gt;</span>protocols  </div><div class="line">                <span class="comment">/* ||  cat-&gt;classProperties */</span>) </div><div class="line">            &#123;</div><div class="line">                <span class="function"><span class="title">addUnattachedCategoryForClass</span>(cat, cls-&gt;</span>ISA(), hi);</div><div class="line">                <span class="function"><span class="title">if</span> (cls-&gt;</span>ISA()-&gt;isRealized()) &#123;</div><div class="line">                    <span class="function"><span class="title">remethodizeClass</span>(cls-&gt;</span>ISA());</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (PrintConnecting) &#123;</div><div class="line">                    _objc_inform(<span class="string">"CLASS: found category +%s(%s)"</span>, </div><div class="line">                                 <span class="function"><span class="title">cls</span>-&gt;</span><span class="function"><span class="title">nameForLogging</span>(), cat-&gt;</span><span class="keyword">name</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>进入<code>remethodizeClass(cls);</code>方法看一下它的实现：</p>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> void remethodizeClass(<span class="class"><span class="keyword">Class</span> <span class="title">cls</span>)</span></div><div class="line">&#123;</div><div class="line">    category_list *cats;</div><div class="line">    <span class="keyword">bool</span> isMeta;</div><div class="line"></div><div class="line">    runtimeLock.assertWriting();</div><div class="line"></div><div class="line">    isMeta = cls-&gt;isMetaClass();</div><div class="line"></div><div class="line">    <span class="comment">// Re-methodizing: check for more categories</span></div><div class="line">    <span class="keyword">if</span> ((cats = unattachedCategoriesForClass(cls, <span class="keyword">false</span><span class="comment">/*not realizing*/</span>))) &#123;</div><div class="line">        <span class="keyword">if</span> (PrintConnecting) &#123;</div><div class="line">            _objc_inform(<span class="string">"CLASS: attaching categories to class '%s' %s"</span>, </div><div class="line">                         cls-&gt;nameForLogging(), isMeta ? <span class="string">"(meta)"</span> : <span class="string">""</span>);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        attachCategories(cls, cats, <span class="keyword">true</span> <span class="comment">/*flush caches*/</span>);        </div><div class="line">        free(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法用来添加指定类的分类，具体的实现可以看 <code>attachCategories</code> 这个方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> </span></div><div class="line"><span class="title">attachCategories</span><span class="params">(Class cls, category_list *cats, <span class="keyword">bool</span> flush_caches)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!cats) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> (PrintReplacedMethods) printReplacements(cls, cats);</div><div class="line"></div><div class="line">    <span class="keyword">bool</span> isMeta = cls-&gt;isMetaClass();</div><div class="line"></div><div class="line">    <span class="comment">// fixme rearrange to remove these intermediate allocations</span></div><div class="line">    <span class="keyword">method_list_t</span> **mlists = (<span class="keyword">method_list_t</span> **)</div><div class="line">        <span class="built_in">malloc</span>(cats-&gt;count * <span class="keyword">sizeof</span>(*mlists));</div><div class="line">    <span class="keyword">property_list_t</span> **proplists = (<span class="keyword">property_list_t</span> **)</div><div class="line">        <span class="built_in">malloc</span>(cats-&gt;count * <span class="keyword">sizeof</span>(*proplists));</div><div class="line">    <span class="keyword">protocol_list_t</span> **protolists = (<span class="keyword">protocol_list_t</span> **)</div><div class="line">        <span class="built_in">malloc</span>(cats-&gt;count * <span class="keyword">sizeof</span>(*protolists));</div><div class="line"></div><div class="line">    <span class="comment">// Count backwards through cats to get newest categories first</span></div><div class="line">    <span class="keyword">int</span> mcount = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> propcount = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> protocount = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i = cats-&gt;count;</div><div class="line">    <span class="keyword">bool</span> fromBundle = NO;</div><div class="line">    <span class="keyword">while</span> (i--) &#123;</div><div class="line">        <span class="keyword">auto</span>&amp; entry = cats-&gt;<span class="built_in">list</span>[i];</div><div class="line"></div><div class="line">        <span class="keyword">method_list_t</span> *mlist = entry.cat-&gt;methodsForMeta(isMeta);</div><div class="line">        <span class="keyword">if</span> (mlist) &#123;</div><div class="line">            mlists[mcount++] = mlist;</div><div class="line">            fromBundle |= entry.hi-&gt;isBundle();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">property_list_t</span> *proplist = entry.cat-&gt;propertiesForMeta(isMeta);</div><div class="line">        <span class="keyword">if</span> (proplist) &#123;</div><div class="line">            proplists[propcount++] = proplist;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">protocol_list_t</span> *protolist = entry.cat-&gt;protocols;</div><div class="line">        <span class="keyword">if</span> (protolist) &#123;</div><div class="line">            protolists[protocount++] = protolist;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">auto</span> rw = cls-&gt;data();</div><div class="line"></div><div class="line">    prepareMethodLists(cls, mlists, mcount, NO, fromBundle);</div><div class="line">    rw-&gt;methods.attachLists(mlists, mcount);</div><div class="line">    <span class="built_in">free</span>(mlists);</div><div class="line">    <span class="keyword">if</span> (flush_caches  &amp;&amp;  mcount &gt; <span class="number">0</span>) flushCaches(cls);</div><div class="line"></div><div class="line">    rw-&gt;properties.attachLists(proplists, propcount);</div><div class="line">    <span class="built_in">free</span>(proplists);</div><div class="line"></div><div class="line">    rw-&gt;protocols.attachLists(protolists, protocount);</div><div class="line">    <span class="built_in">free</span>(protolists);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 代码块：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">    rw-&gt;methods.attachLists<span class="comment">(mlists, mcount)</span>;</div><div class="line">    free<span class="comment">(mlists)</span>;</div><div class="line">    <span class="keyword">if</span> <span class="comment">(flush_caches  &amp;&amp;  mcount &gt; 0)</span> flushCaches<span class="comment">(cls)</span>;</div><div class="line"></div><div class="line">    rw-&gt;properties.attachLists<span class="comment">(proplists, propcount)</span>;</div><div class="line">    free<span class="comment">(proplists)</span>;</div><div class="line"></div><div class="line">    rw-&gt;protocols.attachLists<span class="comment">(protolists, protocount)</span>;</div><div class="line">    free<span class="comment">(protolists)</span>;</div></pre></td></tr></table></figure>
<p>就是用来添加 分类的额方法、属性、协议的，很明显<code>properties</code>是苹果预留的。<code>attachLists</code>方法在上面已经说过啦。新加载的方法会被插入到已有方法列表的前面。</p>
<p>小结：通过以上的分析，我们就知道一些原理，为什么子类覆盖父类的额方法 会调用子类方法，如果分类实现了原有类的 方法也只会调用分类的方法。因为后面加载的类或者分类的方法会被插入到 方法列表的前面，当调用一个方法时，他会去检索方法列表，所以第一个找到匹配的方法就会被调用。</p>
<p><strong>郑重声明：未经本人允许严禁任何组织或个人转载！</strong></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/09/12/runtimeClassLoad/" data-id="cit137adc0005heagrqqgf5q7" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2016/09/12/dylib1/" class="next">mac和iPhone命令生成可执行文件的区别</a></div><div data-thread-key="2016/09/12/runtimeClassLoad/" data-title="iOS 运行时类的加载深入解析" data-url="http://yoursite.com/2016/09/12/runtimeClassLoad/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/09/12/runtimeClassLoad/" data-title="iOS 运行时类的加载深入解析" data-url="http://yoursite.com/2016/09/12/runtimeClassLoad/" data-author-key="1" class="ds-thread"></div><div id="disqus_thread"><script>var disqus_shortname = 'wmf00032-github-io';
var disqus_identifier = '2016/09/12/runtimeClassLoad/';
var disqus_title = 'iOS 运行时类的加载深入解析';
var disqus_url = 'http://yoursite.com/2016/09/12/runtimeClassLoad/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wmf00032-github-io.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://yoursite.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/09/12/runtimeClassLoad/">iOS 运行时类的加载深入解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/12/dylib1/">mac和iPhone命令生成可执行文件的区别</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/06/wechat-secret-4/">（非越狱版）iOS微信聊天加密插件 （四）终结篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/06/wechat-secret-3/">（非越狱版）iOS微信聊天加密插件 （三）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/06/wechat-secret-2/">（非越狱版）iOS微信聊天加密插件 （二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/06/wechat-secret/">（非越狱版）iOS微信聊天加密插件 （一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/12/afnetworking-know-what/">AFNetWorking 深度理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/09/my-new-wmf/">iOS 基于AVPLayer封装视频播放器</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//wmf00032-github-io.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">王孟发.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'wmf00032'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>